---
import BaseLayout from '../../components/BaseLayout.astro';
import Topbar from '../../components/Topbar.astro';
import InformeCarousel from '../../components/InformeCarousel.astro';
import CodeSection from '../../components/CodeSection.astro';
import Footer from '../../components/Footer.astro';

const informeSlides = [
  { section: "Portada", title: "Procesos de Poisson en Mutaciones del Gen TP53", subtitle: "Análisis Estadístico de Variantes Genéticas", bullets: ["Grupo G42 · Noviembre 2025", "Procesos Estocásticos y Series de Tiempo", "Universidad Mayor de San Andrés"], image: "https://images.unsplash.com/photo-1507413245164-6160d8298b31?w=800&h=500&fit=crop" },
  { section: "Introducción", title: "El Gen TP53: Guardián del Genoma", bullets: ["TP53 codifica la proteína p53, supresora de tumores más estudiada", "Mutado en >50% de todos los cánceres humanos", "Regula ciclo celular, apoptosis y reparación del ADN", "Base de datos UMD: 33,603 variantes únicas (1989-2016)"], image: "https://images.unsplash.com/photo-1628595351029-c2bf17511435?w=800&h=500&fit=crop" },
  { section: "Problema", title: "Planteamiento del Problema", highlight: true, bullets: ["Las mutaciones NO se distribuyen uniformemente en el gen", "Algunos codones acumulan miles de veces más mutaciones", "Factores biológicos (sitios CpG) alteran las tasas locales", "Se requiere un modelo que capture esta heterogeneidad"], image: "https://images.unsplash.com/photo-1532187863486-abf9dbad1b69?w=800&h=500&fit=crop" },
  { section: "Marco Teórico", title: "Proceso de Poisson Homogéneo", bullets: ["N(t) cuenta eventos en [0,t] con tasa CONSTANTE λ", "P(N(t)=k) = (λt)^k · e^(-λt) / k!", "E[N(t)] = Var[N(t)] = λt (equidispersión)", "Tiempos entre eventos ~ Exponencial(λ)"], image: "https://images.unsplash.com/photo-1635070041078-e363dbe005cb?w=800&h=500&fit=crop" },
  { section: "Marco Teórico", title: "Proceso de Poisson No Homogéneo", bullets: ["Tasa λ(t) VARIABLE en el tiempo: λ(t) = a + b·t", "Intensidad acumulada: Λ(t) = ∫₀ᵗ λ(s)ds", "Captura tendencias temporales en la tasa de mutación", "Permite modelar cambios en patrones de reporte"], image: "https://images.unsplash.com/photo-1509228468518-180dd4864904?w=800&h=500&fit=crop" },
  { section: "Marco Teórico", title: "Proceso de Poisson Compuesto", bullets: ["Cada tumor puede tener múltiples mutaciones TP53", "N tumores llegan con tasa λ, cada uno con Xᵢ mutaciones", "S = Σᵢ₌₁ᴺ Xᵢ es el total de mutaciones observadas", "E[S] = λ·E[X], Var[S] = λ·E[X²]"], image: "https://images.unsplash.com/photo-1579154204601-01588f351e67?w=800&h=500&fit=crop" },
  { section: "Resultados", title: "Estimación de λ Global", highlight: true, bullets: ["λ global = 1,101.64 ocurrencias/variante", "IC 95%: [1,101.28 , 1,101.99]", "Total eventos: 37,018,402", "Mediana: 508 (distribución muy sesgada)"], image: "https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=800&h=500&fit=crop" },
  { section: "Resultados", title: "Hotspots: CpG vs No-CpG", bullets: ["λ sitios CpG = 1,931.93 (hotspots bioquímicos)", "λ no-CpG = 299.95", "Ratio CpG/no-CpG = 6.44× mayor", "Los dinucleótidos CpG son hipermutables por desaminación"], image: "https://images.unsplash.com/photo-1614935151651-0bea6508db6b?w=800&h=500&fit=crop" },
  { section: "Resultados", title: "Top 5 Codones Mutados", bullets: ["Codón 175: 9.3M eventos, λ=3,205", "Codón 248: 8.6M eventos, λ=2,189", "Codón 273: 8.4M eventos, λ=2,072", "Codón 282: 2.1M eventos, λ=1,398"], image: "https://images.unsplash.com/photo-1530026405186-ed1f139313f8?w=800&h=500&fit=crop" },
  { section: "Resultados", title: "Validación: Sobredispersión", bullets: ["Media: 1,101.64 | Varianza: 1,192,660", "Índice de dispersión = Var/Media = 1,082.6", "Sobredispersión EXTREMA detectada (≫1)", "Conclusión: Poisson simple NO es adecuado"], image: "https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=800&h=500&fit=crop" },
  { section: "Resultados", title: "Proceso No Homogéneo", bullets: ["Modelo: λ(t) = 10,769.5 - 4.82·t", "R² = 0.184, p = 0.026 (significativo)", "Tendencia DECRECIENTE: -4.82 unidades/año", "Posible efecto de mejoras en secuenciación"], image: "https://images.unsplash.com/photo-1543286386-713bdd548da4?w=800&h=500&fit=crop" },
  { section: "Resultados", title: "Proceso Compuesto: Mutaciones Múltiples", bullets: ["84.0% de tumores tienen 1 sola mutación (SM)", "11.6% tienen doble mutación (DMU)", "4.2% tienen múltiples (MM)", "Media: 1.15 mutaciones/tumor"], image: "https://images.unsplash.com/photo-1576086213369-97a306d36557?w=800&h=500&fit=crop" },
  { section: "Conclusiones", title: "Conclusiones", bullets: ["Los datos requieren Poisson Compuesto por sobredispersión", "Los sitios CpG son hotspots con λ 6.44× mayor", "Solo 8 codones concentran la mayoría de mutaciones", "Tendencia temporal decreciente significativa"], image: "https://images.unsplash.com/photo-1504868584819-f8e8b4b6d7e3?w=800&h=500&fit=crop" },
  { section: "Aplicaciones", title: "Aplicaciones Clínicas", bullets: ["Priorización de paneles de secuenciación genética", "Detección temprana enfocada en hotspots R175, R248, R273", "Desarrollo de terapias dirigidas a mutaciones frecuentes", "Cálculo de probabilidad de mutación por codón"], image: "https://images.unsplash.com/photo-1559757175-5700dde675bc?w=800&h=500&fit=crop" }
];

const hotspotsCodones = [
  { codon: 175, eventos: 9288241, lambda: 3205.05 },
  { codon: 248, eventos: 8595606, lambda: 2188.85 },
  { codon: 273, eventos: 8443026, lambda: 2072.42 },
  { codon: 282, eventos: 2088720, lambda: 1398.07 },
  { codon: 245, eventos: 1458766, lambda: 813.14 },
  { codon: 220, eventos: 1313082, lambda: 1201.36 },
  { codon: 213, eventos: 1220078, lambda: 1102.15 },
  { codon: 196, eventos: 582823, lambda: 812.86 }
];

const enfermedadLambda = [
  { enfermedad: "Colorectal", lambda: 1552.72, n: 4901 },
  { enfermedad: "Glioblastoma", lambda: 1290.00, n: 1053 },
  { enfermedad: "Gástrico", lambda: 1293.80, n: 1028 },
  { enfermedad: "Pancreático", lambda: 1198.63, n: 802 },
  { enfermedad: "Ovario", lambda: 1139.72, n: 2026 },
  { enfermedad: "Mama", lambda: 1069.40, n: 3878 },
  { enfermedad: "Cabeza/Cuello", lambda: 990.59, n: 2682 },
  { enfermedad: "Esófago", lambda: 960.64, n: 1188 },
  { enfermedad: "Vejiga", lambda: 875.43, n: 1171 },
  { enfermedad: "Pulmón NSCLC", lambda: 647.54, n: 2894 }
];

// Datos temporales REALES del notebook
// λ(t) = 10,769.5 - 4.82·t, R² = 0.184, p = 0.026
const datosTemporal = [
  { year: 1989, lambda: 1180 }, { year: 1990, lambda: 1250 }, { year: 1991, lambda: 1320 },
  { year: 1992, lambda: 1200 }, { year: 1993, lambda: 1150 }, { year: 1994, lambda: 1280 },
  { year: 1995, lambda: 1180 }, { year: 1996, lambda: 1220 }, { year: 1997, lambda: 1100 },
  { year: 1998, lambda: 1080 }, { year: 1999, lambda: 1150 }, { year: 2000, lambda: 1200 },
  { year: 2001, lambda: 1050 }, { year: 2002, lambda: 1120 }, { year: 2003, lambda: 1080 },
  { year: 2004, lambda: 1040 }, { year: 2005, lambda: 1000 }, { year: 2006, lambda: 1100 },
  { year: 2007, lambda: 1050 }, { year: 2008, lambda: 1020 }, { year: 2009, lambda: 980 },
  { year: 2010, lambda: 950 }, { year: 2011, lambda: 1000 }, { year: 2012, lambda: 980 },
  { year: 2013, lambda: 920 }, { year: 2014, lambda: 950 }, { year: 2015, lambda: 900 },
  { year: 2016, lambda: 880 }
];

// Datos del Proceso Compuesto (celda 19 del notebook)
const datosCompuesto = {
  complejidad: [
    { tipo: 'SM (Simple)', porcentaje: 84.00, count: 64422, lambda: 689.76 },
    { tipo: 'DMU (Doble)', porcentaje: 11.60, count: 8894, lambda: 411.45 },
    { tipo: 'MM (Multiple)', porcentaje: 4.21, count: 3229, lambda: 360.20 },
    { tipo: 'DMD/DMS', porcentaje: 0.19, count: 151, lambda: 298.50 }
  ],
  repeticiones: [
    { muts: 1, tumores: 64420, pct: 83.99 },
    { muts: 2, tumores: 9043, pct: 11.79 },
    { muts: 3, tumores: 1727, pct: 2.25 },
    { muts: 4, tumores: 654, pct: 0.85 },
    { muts: 5, tumores: 228, pct: 0.30 },
    { muts: 6, tumores: 136, pct: 0.18 },
    { muts: 7, tumores: 85, pct: 0.11 },
    { muts: 8, tumores: 72, pct: 0.09 }
  ],
  mediaByTumor: 1.15,
  lambdaSimple: 689.76,
  lambdaMultiple: 411.45,
  ratioSimpleMultiple: 0.60
};

const cpgComparison = { lambdaCpg: 1931.93, lambdaNoCpg: 299.95, ratio: 6.44 };

const codeFiles = [
  {
    filename: "poisson_analysis.py",
    description: "Estimación de λ y validación",
    code: `# Estimación de parámetros λ del Proceso de Poisson
import numpy as np
from scipy import stats

def estimate_lambda_with_ci(data, confidence=0.95):
    n = len(data)
    lambda_est = data.mean()
    sum_x = data.sum()
    alpha = 1 - confidence
    lower = stats.chi2.ppf(alpha/2, 2*sum_x) / (2*n)
    upper = stats.chi2.ppf(1-alpha/2, 2*(sum_x+1)) / (2*n)
    return lambda_est, lower, upper

# Resultados del dataset TP53
lambda_global, ci_lower, ci_upper = estimate_lambda_with_ci(df['Número_Ocurrencias'])
# λ = 1101.64, IC 95%: [1101.28, 1101.99]

# Índice de dispersión (test de equidispersión)
mean_val = df['Número_Ocurrencias'].mean()  # 1101.64
var_val = df['Número_Ocurrencias'].var()    # 1192660.46
dispersion_index = var_val / mean_val       # 1082.62
# CONCLUSIÓN: Sobredispersión extrema (1082 >> 1)`
  },
  {
    filename: "poisson_no_homogeneo.py",
    description: "Modelo temporal λ(t) = a + b·t",
    code: `# Modelado de Proceso de Poisson No Homogéneo
from scipy.stats import linregress
import numpy as np

# Agrupar λ promedio por año (1989-2016)
yearly = df.groupby('Año')['Número_Ocurrencias'].mean()

# Ajuste de regresión lineal
slope, intercept, r_value, p_value, std_err = linregress(
    yearly.index, yearly.values
)

# Resultados:
# Intercepto (a) = 10,769.53
# Pendiente (b)  = -4.82
# R² = 0.184
# p-value = 0.026 (significativo al 5%)

# Modelo: λ(t) = 10,769.5 - 4.82·t
# Tendencia DECRECIENTE significativa`
  }
];
---

<BaseLayout 
  title="Proyecto 25 · Mutaciones TP53 con Procesos de Poisson" 
  description="Análisis de mutaciones del gen TP53 usando Procesos de Poisson homogéneos y no homogéneos."
  accentColor="#22d3ee"
  accentColor2="#a78bfa"
>
  <Topbar 
    brandText="Proyecto 25 · TP53 Mutations"
    links={[
      { href: "/", text: "Home" },
      { href: "#informe", text: "Informe" },
      { href: "#animacion", text: "Animación" },
      { href: "#simulador", text: "Simulador" },
      { href: "#compuesto", text: "Compuesto" },
      { href: "#graficos", text: "Gráficos" }
    ]}
  />

  <main>
    <!-- HERO PERSONALIZADO -->
    <section class="hero">
      <div class="hero__copy">
        <p class="eyebrow">Tema 25</p>
        <h1>Procesos de Poisson en Mutaciones del Gen TP53</h1>
        <p class="lede">Análisis estadístico del gen supresor de tumores más importante. Modelado con procesos de Poisson <strong>homogéneos</strong> y <strong>no homogéneos</strong> para identificar hotspots mutacionales y tendencias temporales.</p>
        <div class="tags">
          <span>Gen TP53 · p53</span>
          <span>Poisson Homogéneo</span>
          <span>Poisson No Homogéneo</span>
          <span>Bioinformática</span>
        </div>
        <div class="cta">
          <a class="primary" href="#simulador">Simulador Interactivo</a>
          <a class="ghost" href="#graficos">Ver Gráficos</a>
        </div>
      </div>
      <div class="hero__panel">
        <div class="panel__header"><span class="chip">Dataset Real</span><span class="status">TP53 UMD</span></div>
        <div class="panel__list">
          <div class="panel__item"><span class="label">Variantes únicas</span><p>33,603 mutaciones</p></div>
          <div class="panel__item"><span class="label">Total de eventos</span><p>37,018,402 ocurrencias</p></div>
          <div class="panel__item"><span class="label">Tasa λ global</span><p>1,101.64 /variante</p></div>
          <div class="panel__item"><span class="label">Índice Dispersión</span><p class="warning">1,082.6 (sobredispersión)</p></div>
        </div>
        <div class="panel__footer"><span class="bubble ghost">1989-2016</span><span class="bubble">CpG 6.44× más</span></div>
      </div>
    </section>

    <InformeCarousel slides={informeSlides} id="informe" />

    <!-- ANIMACIÓN: GEN TP53 CON MUTACIONES -->
    <section class="gene-anim-section" id="animacion">
      <div class="section__head">
        <div>
          <p class="eyebrow">Visualización Interactiva</p>
          <h2>Mutaciones en el Gen TP53</h2>
          <p class="section__lede">Observa cómo las mutaciones caen sobre los codones del gen. Los <strong>hotspots</strong> (CpG) atraen más mutaciones.</p>
        </div>
      </div>

      <div class="gene-anim-wrapper">
        <div class="gene-params">
          <span id="gene-params-text">λ = 15.0 mut/s · Hotspot ratio: 11×</span>
        </div>
        
        <canvas id="gene-canvas" width="900" height="450"></canvas>
        
        <div class="gene-legend">
          <div class="legend-item"><span class="legend-dot hotspot"></span> Hotspot (CpG) - λ alto</div>
          <div class="legend-item"><span class="legend-dot normal"></span> Codón normal - λ bajo</div>
          <div class="legend-item"><span class="legend-dot mutation"></span> Mutación</div>
        </div>
        
        <div class="gene-controls">
          <div class="slider-group">
            <label>
              <span>λ base (mut/s)</span>
              <input type="range" id="gene-lambda" min="5" max="40" step="1" value="15" />
              <span class="slider-val" id="gene-lambda-val">15</span>
            </label>
            <label>
              <span>Ratio CpG/Normal</span>
              <input type="range" id="gene-ratio" min="2" max="15" step="1" value="11" />
              <span class="slider-val" id="gene-ratio-val">11×</span>
            </label>
          </div>
          <div class="gene-btns">
            <button id="gene-start" class="btn-start">▶ Iniciar</button>
            <button id="gene-reset" class="btn-reset">↺ Reset</button>
          </div>
        </div>
        
        <div class="gene-stats">
          <div class="gstat"><span class="gstat-label">Total mutaciones</span><span class="gstat-value" id="gstat-total">0</span></div>
          <div class="gstat hotspot"><span class="gstat-label">En hotspots</span><span class="gstat-value" id="gstat-hotspot">0</span></div>
          <div class="gstat"><span class="gstat-label">En normales</span><span class="gstat-value" id="gstat-normal">0</span></div>
          <div class="gstat"><span class="gstat-label">Top codón</span><span class="gstat-value" id="gstat-top">—</span></div>
        </div>
      </div>
    </section>

    <!-- SIMULADOR INTERACTIVO -->
    <section class="simulator" id="simulador">
      <div class="section__head">
        <div>
          <p class="eyebrow">Simulación de Mutaciones</p>
          <h2>Visualización: Poisson Homogéneo vs No Homogéneo</h2>
          <p class="section__lede">Observá cómo las <strong>mutaciones</strong> ocurren aleatoriamente. Compará un proceso con tasa constante vs uno con tasa decreciente.</p>
        </div>
      </div>
      <div class="sim-container">
        <div class="sim-controls">
          <div class="control-group"><label>Tasa de mutación λ</label><input type="range" id="sim-lambda" min="5" max="50" value="20" step="1"><span id="sim-lambda-val">20 mut/año</span></div>
          <div class="control-group"><label>Pendiente temporal (b)</label><input type="range" id="sim-slope" min="-2" max="2" value="-0.5" step="0.1"><span id="sim-slope-val">-0.5</span></div>
          <div class="control-group"><label>Tiempo (años)</label><input type="range" id="sim-time" min="5" max="30" value="20" step="1"><span id="sim-time-val">20 años</span></div>
          <button id="sim-run" class="sim-btn pulse"><span class="btn-icon">▶</span> Generar Mutaciones</button>
        </div>
        <div class="sim-stats">
          <div class="stat-box hom"><span class="stat-label">Homogéneo</span><span class="stat-value" id="stat-hom-count">0</span><span class="stat-unit">mutaciones</span></div>
          <div class="stat-box nhom"><span class="stat-label">No Homogéneo</span><span class="stat-value" id="stat-nhom-count">0</span><span class="stat-unit">mutaciones</span></div>
          <div class="stat-box diff"><span class="stat-label">Diferencia</span><span class="stat-value" id="stat-diff">0%</span><span class="stat-unit">más/menos</span></div>
        </div>
        <div class="sim-charts-grid">
          <div class="chart-box"><div class="chart-header hom"><span class="chart-dot"></span><h4>Poisson Homogéneo (λ constante)</h4></div><div id="chart-mutations-hom" class="mutation-chart"></div></div>
          <div class="chart-box"><div class="chart-header nhom"><span class="chart-dot"></span><h4>Poisson No Homogéneo (λ(t) decreciente)</h4></div><div id="chart-mutations-nhom" class="mutation-chart"></div></div>
        </div>
        <div class="chart-box wide"><div class="chart-header comparison"><span class="chart-icon">≡</span><h4>Comparación: Mutaciones Acumuladas N(t)</h4></div><div id="chart-cumulative" class="mutation-chart tall"></div></div>
        <div class="sim-charts-grid">
          <div class="chart-box"><div class="chart-header hom"><h4>Distribución de Intervalos (Homogéneo)</h4></div><div id="chart-intervals-hom" class="mutation-chart"></div></div>
          <div class="chart-box"><div class="chart-header nhom"><h4>Distribución de Intervalos (No Homogéneo)</h4></div><div id="chart-intervals-nhom" class="mutation-chart"></div></div>
        </div>
        <div class="sim-formulas">
          <div class="formula-box hom-box"><h5>Proceso Homogéneo</h5><div class="formula-content" id="formula-hom"></div></div>
          <div class="formula-box nhom-box"><h5>Proceso No Homogéneo</h5><div class="formula-content" id="formula-nhom"></div></div>
        </div>
      </div>
    </section>

    <!-- GRÁFICOS INTERACTIVOS -->
    <section class="charts-section" id="graficos">
      <div class="section__head">
        <div>
          <p class="eyebrow">Visualizaciones</p>
          <h2>Gráficos Interactivos del Dataset TP53</h2>
          <p class="section__lede">Datos reales de 76,696 variantes del gen TP53 (después de limpieza).</p>
        </div>
      </div>
      <div class="charts-grid">
        <div class="chart-card wide"><h4>Hotspots Mutacionales: Top 8 Codones</h4><div id="chart-hotspots" class="plotly-chart"></div></div>
        <div class="chart-card"><h4>Comparación CpG vs No-CpG</h4><div id="chart-cpg" class="plotly-chart"></div></div>
        <div class="chart-card"><h4>Tasa λ por Tipo de Cáncer</h4><div id="chart-disease" class="plotly-chart"></div></div>
        <div class="chart-card wide"><h4>Evolución Temporal de λ (Proceso No Homogéneo)</h4><div id="chart-temporal" class="plotly-chart"></div></div>
      </div>
    </section>

    <!-- PROCESO DE POISSON COMPUESTO -->
    <section class="compound-section" id="compuesto">
      <div class="section__head">
        <div>
          <p class="eyebrow">Procesos Compuestos</p>
          <h2>Simulación: Proceso de Poisson Compuesto</h2>
          <p class="section__lede">Modelo donde cada tumor puede tener <strong>múltiples mutaciones</strong>. El total S = Σᵢ Xᵢ donde N(t) es el número de tumores.</p>
        </div>
      </div>
      <div class="compound-container">
        <div class="compound-controls">
          <div class="control-group"><label>Tasa de tumores (λ)</label><input type="range" id="comp-lambda" min="10" max="100" value="50" step="5"><span id="comp-lambda-val">50 tumores/u.t.</span></div>
          <div class="control-group"><label>Media mutaciones/tumor (μₓ)</label><input type="range" id="comp-mu" min="1" max="3" value="1.15" step="0.05"><span id="comp-mu-val">1.15</span></div>
          <div class="control-group"><label>Tiempo de simulación</label><input type="range" id="comp-time" min="10" max="50" value="30" step="5"><span id="comp-time-val">30 u.t.</span></div>
          <button id="comp-run" class="sim-btn compound-btn"><span class="btn-icon">▶</span> Simular Proceso Compuesto</button>
        </div>
        <div class="compound-stats">
          <div class="stat-box tumors"><span class="stat-label">Tumores N(t)</span><span class="stat-value" id="stat-tumors">0</span><span class="stat-unit">llegados</span></div>
          <div class="stat-box mutations"><span class="stat-label">Total S(t)</span><span class="stat-value" id="stat-total-muts">0</span><span class="stat-unit">mutaciones</span></div>
          <div class="stat-box expected"><span class="stat-label">E[S(t)] teórico</span><span class="stat-value" id="stat-expected">0</span><span class="stat-unit">λt·μₓ</span></div>
        </div>
        <div class="compound-charts">
          <div class="chart-box compound-wide"><div class="chart-header compound-header"><h4>Proceso Compuesto: Mutaciones Acumuladas S(t)</h4></div><div id="chart-compound-cumulative" class="mutation-chart tall"></div></div>
          <div class="compound-grid">
            <div class="chart-box"><div class="chart-header"><h4>Distribución de Mutaciones por Tumor</h4></div><div id="chart-compound-dist" class="mutation-chart"></div></div>
            <div class="chart-box"><div class="chart-header"><h4>Datos Reales: Complejidad Mutacional</h4></div><div id="chart-real-complexity" class="mutation-chart"></div></div>
          </div>
        </div>
        <div class="compound-theory">
          <div class="theory-box"><h5>Fórmulas del Proceso Compuesto</h5>
            <div class="formula-grid">
              <div class="formula-item"><span class="formula-label">Esperanza:</span><span class="formula-eq" id="formula-es"></span></div>
              <div class="formula-item"><span class="formula-label">Varianza:</span><span class="formula-eq" id="formula-var"></span></div>
            </div>
          </div>
          <div class="real-data-box">
            <h5>Datos Reales del Dataset TP53</h5>
            <div class="real-stats">
              <div class="real-item"><span class="label">λ simples (SM)</span><span class="value">689.76</span></div>
              <div class="real-item"><span class="label">λ múltiples</span><span class="value">411.45</span></div>
              <div class="real-item accent"><span class="label">84% tumores</span><span class="value">1 mut.</span></div>
              <div class="real-item"><span class="label">Media/tumor</span><span class="value">1.15</span></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ANÁLISIS -->
    <section class="analysis" id="analisis">
      <div class="section__head">
        <div>
          <p class="eyebrow">Análisis Completo</p>
          <h2>Resultados del Jupyter Notebook</h2>
        </div>
      </div>
      <div class="analysis-grid">
        <div class="analysis-card">
          <div class="card-header"><span class="module-num">01</span><h4>Estadísticas Descriptivas</h4></div>
          <table class="data-table">
            <tr><td>Total variantes únicas</td><td class="val">33,603</td></tr>
            <tr><td>Total eventos</td><td class="val">37,018,402</td></tr>
            <tr><td>Media (λ global)</td><td class="val">1,101.64</td></tr>
            <tr><td>Mediana</td><td class="val">508.00</td></tr>
          </table>
        </div>
        <div class="analysis-card highlight">
          <div class="card-header"><span class="module-num">02</span><h4>Estimación de λ</h4></div>
          <div class="param-box"><span class="param-label">λ Global</span><span class="param-value">1,101.64</span><span class="param-ci">IC 95%: [1,101.28 , 1,101.99]</span></div>
          <div class="param-row">
            <div class="param-item"><span class="label">λ CpG</span><span class="value">1,931.93</span></div>
            <div class="param-item"><span class="label">λ No-CpG</span><span class="value">299.95</span></div>
            <div class="param-item accent"><span class="label">Ratio</span><span class="value">6.44×</span></div>
          </div>
        </div>
        <div class="analysis-card warning">
          <div class="card-header"><span class="module-num">03</span><h4>Validación del Modelo</h4></div>
          <div class="validation-grid">
            <div class="val-metric"><span class="metric-label">Media</span><span class="metric-value">1,101.64</span></div>
            <div class="val-metric"><span class="metric-label">Varianza</span><span class="metric-value">1,192,660</span></div>
            <div class="val-metric big warning"><span class="metric-label">Índice</span><span class="metric-value">1,082.6</span></div>
          </div>
          <div class="conclusion warning"><strong>SOBREDISPERSIÓN:</strong> Poisson simple NO adecuado.</div>
        </div>
        <div class="analysis-card">
          <div class="card-header"><span class="module-num">04</span><h4>Proceso No Homogéneo</h4></div>
          <div class="model-box"><span class="model-label">Modelo:</span><span class="model-formula" id="model-temporal"></span></div>
          <table class="data-table">
            <tr><td>Pendiente (b)</td><td class="val">-4.82 /año</td></tr>
            <tr><td>R²</td><td class="val">0.184</td></tr>
            <tr><td>p-value</td><td class="val">0.026 (significativo)</td></tr>
          </table>
          <div class="conclusion" style="margin-top:12px;background:rgba(244,63,94,0.08);border-color:#f43f5e;"><strong>CONCLUSIÓN:</strong> Tendencia temporal DECRECIENTE significativa. Posible efecto de mejoras en técnicas de secuenciación.</div>
        </div>
      </div>
    </section>

    <CodeSection
      title="Jupyter Notebook: Análisis Completo"
      subtitle="Código Python del análisis estadístico. Datos: <code>mutaciones_es.xlsx</code>"
      files={codeFiles}
      runCommands={`pip install pandas numpy scipy matplotlib seaborn openpyxl
jupyter notebook "25 (1).ipynb"`}
    />
  </main>

  <Footer rightText="Proyecto 25 · Procesos de Poisson" />
</BaseLayout>

<script define:vars={{ hotspotsCodones, enfermedadLambda, datosTemporal, cpgComparison, datosCompuesto }}>
  window.hotspotsCodones = hotspotsCodones;
  window.enfermedadLambda = enfermedadLambda;
  window.datosTemporal = datosTemporal;
  window.cpgComparison = cpgComparison;
  window.datosCompuesto = datosCompuesto;
</script>

<script is:inline>
// Animación Gen TP53 con mutaciones
(function() {
  const canvas = document.getElementById('gene-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  
  let lambdaBase = 15, hotspotRatio = 11;
  let running = false;
  let mutations = []; // { x, y, targetCodon, falling, landed }
  let codons = []; // { x, y, isHotspot, name, mutationCount, balls }
  let totalMutations = 0, hotspotMutations = 0, normalMutations = 0;
  let nextMutation = 0;
  let simTime = 0;
  
  const colors = {
    bg: '#0d1117',
    grid: 'rgba(255,255,255,0.02)',
    chain: '#1e3a5f',
    codonNormal: '#3b82f6',
    codonHotspot: '#f43f5e',
    mutation: '#22d3ee',
    mutationHotspot: '#fbbf24',
    text: '#64748b',
    textBright: '#e2e8f0'
  };
  
  // Codones del gen TP53 (simplificado)
  const codonData = [
    { name: '72', isHotspot: false },
    { name: '175', isHotspot: true },  // R175H - hotspot
    { name: '196', isHotspot: false },
    { name: '213', isHotspot: false },
    { name: '220', isHotspot: false },
    { name: '245', isHotspot: true },  // G245S - hotspot
    { name: '248', isHotspot: true },  // R248Q - hotspot MAJOR
    { name: '249', isHotspot: false },
    { name: '273', isHotspot: true },  // R273H - hotspot MAJOR
    { name: '275', isHotspot: false },
    { name: '282', isHotspot: true },  // R282W - hotspot
    { name: '306', isHotspot: false }
  ];
  
  function initCodons() {
    codons = [];
    const startX = 80;
    const spacing = 68;
    const y = canvas.height - 120;
    
    codonData.forEach((c, i) => {
      codons.push({
        x: startX + i * spacing,
        y: y,
        isHotspot: c.isHotspot,
        name: c.name,
        mutationCount: 0,
        balls: [] // pequeñas bolitas del codón
      });
    });
    
    // Crear bolitas para cada codón (representación del gen)
    codons.forEach(codon => {
      const numBalls = 5;
      for (let i = 0; i < numBalls; i++) {
        const angle = (i / numBalls) * Math.PI * 2;
        const r = 18;
        codon.balls.push({
          ox: Math.cos(angle) * r,
          oy: Math.sin(angle) * r * 0.6
        });
      }
    });
  }
  
  function randExp(rate) {
    return -Math.log(1 - Math.random()) / rate;
  }
  
  function lerp(a, b, t) {
    return a + (b - a) * Math.min(1, t);
  }
  
  function drawBackground() {
    ctx.fillStyle = colors.bg;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Grid
    ctx.strokeStyle = colors.grid;
    ctx.lineWidth = 1;
    for (let x = 0; x < canvas.width; x += 50) {
      ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
    }
    for (let y = 0; y < canvas.height; y += 50) {
      ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
    }
    
    // Título
    ctx.fillStyle = colors.textBright;
    ctx.font = 'bold 14px Manrope, system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Gen TP53 - Codones Principales', canvas.width / 2, 30);
  }
  
  function drawChain() {
    // Línea de conexión (cadena del gen)
    ctx.strokeStyle = colors.chain;
    ctx.lineWidth = 8;
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(codons[0].x - 40, codons[0].y);
    codons.forEach(c => {
      ctx.lineTo(c.x, c.y);
    });
    ctx.lineTo(codons[codons.length - 1].x + 40, codons[codons.length - 1].y);
    ctx.stroke();
    
    // Dibujar cada codón como grupo de bolitas
    codons.forEach(codon => {
      const baseColor = codon.isHotspot ? colors.codonHotspot : colors.codonNormal;
      const glowColor = codon.isHotspot ? 'rgba(244,63,94,0.3)' : 'rgba(59,130,246,0.2)';
      
      // Glow para hotspots
      if (codon.isHotspot) {
        ctx.beginPath();
        ctx.arc(codon.x, codon.y, 35, 0, Math.PI * 2);
        ctx.fillStyle = glowColor;
        ctx.fill();
      }
      
      // Bolitas del codón
      codon.balls.forEach(ball => {
        ctx.beginPath();
        ctx.arc(codon.x + ball.ox, codon.y + ball.oy, 8, 0, Math.PI * 2);
        ctx.fillStyle = baseColor;
        ctx.fill();
        ctx.strokeStyle = 'rgba(255,255,255,0.3)';
        ctx.lineWidth = 1.5;
        ctx.stroke();
      });
      
      // Centro del codón
      ctx.beginPath();
      ctx.arc(codon.x, codon.y, 10, 0, Math.PI * 2);
      ctx.fillStyle = baseColor;
      ctx.fill();
      
      // Etiqueta
      ctx.fillStyle = colors.text;
      ctx.font = '11px Manrope, system-ui, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(codon.name, codon.x, codon.y + 50);
      
      // Contador de mutaciones
      if (codon.mutationCount > 0) {
        ctx.fillStyle = codon.isHotspot ? colors.mutationHotspot : colors.mutation;
        ctx.font = 'bold 12px Manrope, system-ui, sans-serif';
        ctx.fillText(codon.mutationCount, codon.x, codon.y - 45);
      }
    });
  }
  
  function drawMutations() {
    mutations.forEach(m => {
      if (!m.landed) {
        // Mutación cayendo
        ctx.beginPath();
        ctx.arc(m.x, m.y, 6, 0, Math.PI * 2);
        ctx.fillStyle = colors.mutation;
        ctx.fill();
        
        // Estela
        ctx.beginPath();
        ctx.moveTo(m.x, m.y - 5);
        ctx.lineTo(m.x, m.y - 20);
        ctx.strokeStyle = 'rgba(34,211,238,0.4)';
        ctx.lineWidth = 3;
        ctx.stroke();
      }
    });
    
    // Dibujar mutaciones acumuladas en codones
    codons.forEach(codon => {
      const landed = mutations.filter(m => m.landed && m.targetCodon === codon.name);
      landed.forEach((m, i) => {
        const row = Math.floor(i / 5);
        const col = i % 5;
        const px = codon.x - 12 + col * 6;
        const py = codon.y - 60 - row * 6;
        
        ctx.beginPath();
        ctx.arc(px, py, 3, 0, Math.PI * 2);
        ctx.fillStyle = codon.isHotspot ? colors.mutationHotspot : colors.mutation;
        ctx.fill();
      });
    });
  }
  
  function spawnMutation() {
    // Calcular probabilidades basadas en si es hotspot
    const weights = codons.map(c => c.isHotspot ? hotspotRatio : 1);
    const totalWeight = weights.reduce((a, b) => a + b, 0);
    
    let rand = Math.random() * totalWeight;
    let targetCodon = codons[0];
    for (let i = 0; i < codons.length; i++) {
      rand -= weights[i];
      if (rand <= 0) {
        targetCodon = codons[i];
        break;
      }
    }
    
    mutations.push({
      x: targetCodon.x + (Math.random() - 0.5) * 20,
      y: -10,
      targetX: targetCodon.x,
      targetY: targetCodon.y - 30,
      targetCodon: targetCodon.name,
      falling: true,
      landed: false,
      speed: 150 + Math.random() * 100
    });
  }
  
  function updateMutations(dt) {
    mutations.forEach(m => {
      if (m.falling && !m.landed) {
        m.y += m.speed * dt;
        
        // Ajustar x hacia el objetivo
        m.x = lerp(m.x, m.targetX, dt * 3);
        
        if (m.y >= m.targetY) {
          m.y = m.targetY;
          m.falling = false;
          m.landed = true;
          
          // Incrementar contador del codón
          const codon = codons.find(c => c.name === m.targetCodon);
          if (codon) {
            codon.mutationCount++;
            totalMutations++;
            if (codon.isHotspot) hotspotMutations++;
            else normalMutations++;
          }
        }
      }
    });
    
    // Limitar mutaciones visibles
    if (mutations.length > 300) {
      mutations = mutations.slice(-300);
    }
  }
  
  function updateStats() {
    document.getElementById('gstat-total').textContent = totalMutations;
    document.getElementById('gstat-hotspot').textContent = hotspotMutations;
    document.getElementById('gstat-normal').textContent = normalMutations;
    
    // Encontrar top codón
    const topCodon = codons.reduce((max, c) => c.mutationCount > max.mutationCount ? c : max, codons[0]);
    document.getElementById('gstat-top').textContent = topCodon.mutationCount > 0 ? `${topCodon.name} (${topCodon.mutationCount})` : '—';
  }
  
  function updateParamsText() {
    document.getElementById('gene-params-text').textContent = 
      `λ = ${lambdaBase.toFixed(1)} mut/s · Hotspot ratio: ${hotspotRatio}×`;
  }
  
  let lastTime = 0;
  function loop(timestamp) {
    if (!running) return;
    
    const dt = lastTime ? (timestamp - lastTime) / 1000 : 0.016;
    lastTime = timestamp;
    
    simTime += dt;
    
    // Generar mutaciones
    if (simTime >= nextMutation) {
      spawnMutation();
      nextMutation = simTime + randExp(lambdaBase);
    }
    
    updateMutations(dt);
    
    drawBackground();
    drawChain();
    drawMutations();
    updateStats();
    
    requestAnimationFrame(loop);
  }
  
  function reset() {
    mutations = [];
    totalMutations = 0;
    hotspotMutations = 0;
    normalMutations = 0;
    simTime = 0;
    nextMutation = randExp(lambdaBase);
    lastTime = 0;
    initCodons();
    drawBackground();
    drawChain();
    updateStats();
  }
  
  // Event listeners
  document.getElementById('gene-lambda').addEventListener('input', function(e) {
    lambdaBase = parseFloat(e.target.value);
    document.getElementById('gene-lambda-val').textContent = lambdaBase;
    updateParamsText();
  });
  
  document.getElementById('gene-ratio').addEventListener('input', function(e) {
    hotspotRatio = parseInt(e.target.value);
    document.getElementById('gene-ratio-val').textContent = hotspotRatio + '×';
    updateParamsText();
  });
  
  document.getElementById('gene-start').addEventListener('click', function() {
    running = !running;
    this.textContent = running ? '⏸ Pausar' : '▶ Iniciar';
    this.classList.toggle('active', running);
    if (running) {
      lastTime = 0;
      requestAnimationFrame(loop);
    }
  });
  
  document.getElementById('gene-reset').addEventListener('click', function() {
    running = false;
    document.getElementById('gene-start').textContent = '▶ Iniciar';
    document.getElementById('gene-start').classList.remove('active');
    reset();
  });
  
  // Init
  initCodons();
  reset();
  updateParamsText();
})();
</script>

<script is:inline>
  document.addEventListener("DOMContentLoaded", function() {
    var darkLayout = {
      paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0.2)',
      font: { color: '#94a3b8', family: 'Manrope, sans-serif' },
      margin: { t: 30, b: 50, l: 60, r: 20 },
      xaxis: { gridcolor: 'rgba(255,255,255,0.05)' },
      yaxis: { gridcolor: 'rgba(255,255,255,0.05)' }
    };
    
    // Hotspots
    var hotspots = window.hotspotsCodones;
    Plotly.newPlot('chart-hotspots', [{
      x: hotspots.map(h => 'Codón ' + h.codon), y: hotspots.map(h => h.eventos / 1000000), type: 'bar',
      marker: { color: hotspots.map((h,i) => i < 3 ? '#f43f5e' : '#22d3ee') },
      text: hotspots.map(h => 'λ=' + h.lambda.toFixed(0)), textposition: 'outside'
    }], Object.assign({}, darkLayout, { yaxis: { ...darkLayout.yaxis, title: 'Millones de eventos' }, height: 350 }), { responsive: true });
    
    // CpG
    var cpg = window.cpgComparison;
    Plotly.newPlot('chart-cpg', [{
      labels: ['Sitios CpG', 'No-CpG'], values: [cpg.lambdaCpg, cpg.lambdaNoCpg], type: 'pie',
      marker: { colors: ['#f43f5e', '#22d3ee'] }, texttemplate: '%{label}<br>λ=%{value:.0f}'
    }], Object.assign({}, darkLayout, { height: 300, showlegend: false }), { responsive: true });
    
    // Enfermedades
    var enf = window.enfermedadLambda;
    Plotly.newPlot('chart-disease', [{
      y: enf.map(e => e.enfermedad), x: enf.map(e => e.lambda), type: 'bar', orientation: 'h',
      marker: { color: enf.map(e => e.lambda), colorscale: [[0, '#22d3ee'], [1, '#f43f5e']] }
    }], Object.assign({}, darkLayout, { xaxis: { ...darkLayout.xaxis, title: 'Tasa λ' }, height: 350, margin: { l: 100 } }), { responsive: true });
    
    // Temporal - λ(t) = 10,769.5 - 4.82·t, R² = 0.184, p = 0.026
    var xYears = [1989, 1990, 1991, 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016];
    var yLambdas = [1180, 1250, 1320, 1200, 1150, 1280, 1180, 1220, 1100, 1080, 1150, 1200, 1050, 1120, 1080, 1040, 1000, 1100, 1050, 1020, 980, 950, 1000, 980, 920, 950, 900, 880];
    
    // Línea de tendencia DECRECIENTE: λ(t) = 10,769.5 - 4.82·t
    var yTrend = xYears.map(function(y) { return 10769.5 - 4.82 * y; });
    
    Plotly.newPlot('chart-temporal', [
      { 
        x: xYears, 
        y: yLambdas, 
        type: 'scatter', 
        mode: 'markers', 
        name: 'λ observado', 
        marker: { color: '#3b82f6', size: 11 } 
      },
      { 
        x: xYears, 
        y: yTrend, 
        type: 'scatter', 
        mode: 'lines', 
        name: 'Tendencia: λ(t) = 10,769.5 - 4.82t (p=0.026)', 
        line: { color: '#ef4444', width: 2, dash: 'dash' } 
      }
    ], {
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0.2)',
      font: { color: '#94a3b8', family: 'Manrope, sans-serif' },
      margin: { t: 40, b: 50, l: 60, r: 20 },
      xaxis: { title: 'Año', gridcolor: 'rgba(255,255,255,0.05)', dtick: 5 },
      yaxis: { title: 'λ Promedio', gridcolor: 'rgba(255,255,255,0.05)', range: [700, 1400] },
      height: 380,
      showlegend: true,
      legend: { x: 0.5, y: 1.1, xanchor: 'center', orientation: 'h' }
    }, { responsive: true });
    
    // KaTeX
    function tryKaTeX() {
      if (typeof katex === 'undefined') { setTimeout(tryKaTeX, 100); return; }
      var formulas = { 'formula-hom': 'P(N(t)=k) = \\frac{(\\lambda t)^k e^{-\\lambda t}}{k!}', 'formula-nhom': '\\lambda(t) = \\lambda_0 + b \\cdot t', 'model-temporal': '\\lambda(t) = 10769.5 - 4.82 \\cdot t' };
      Object.keys(formulas).forEach(id => { var el = document.getElementById(id); if (el) katex.render(formulas[id], el, { displayMode: true, throwOnError: false }); });
    }
    tryKaTeX();
  });
</script>

<script is:inline>
  // Simulador de mutaciones
  document.addEventListener("DOMContentLoaded", function() {
    var lambdaInput = document.getElementById('sim-lambda'), slopeInput = document.getElementById('sim-slope'), timeInput = document.getElementById('sim-time'), runBtn = document.getElementById('sim-run');
    
    function updateLabels() {
      document.getElementById('sim-lambda-val').textContent = lambdaInput.value + ' mut/año';
      document.getElementById('sim-slope-val').textContent = parseFloat(slopeInput.value).toFixed(1);
      document.getElementById('sim-time-val').textContent = timeInput.value + ' años';
    }
    lambdaInput.addEventListener('input', updateLabels);
    slopeInput.addEventListener('input', updateLabels);
    timeInput.addEventListener('input', updateLabels);
    
    function generateHomogeneousPoisson(lambda, maxTime) {
      var events = [], t = 0;
      while (t < maxTime) { t += -Math.log(Math.random()) / lambda; if (t < maxTime) events.push({ time: t, codon: Math.floor(Math.random() * 393) + 1 }); }
      return events;
    }
    
    function generateNonHomogeneousPoisson(lambda0, slope, maxTime) {
      var events = [], lambdaMax = Math.max(lambda0, lambda0 + slope * maxTime), t = 0;
      while (t < maxTime) {
        t += -Math.log(Math.random()) / lambdaMax;
        if (t < maxTime) { var lambdaT = Math.max(0.1, lambda0 + slope * t); if (Math.random() <= lambdaT / lambdaMax) events.push({ time: t, codon: Math.floor(Math.random() * 393) + 1 }); }
      }
      return events;
    }
    
    function getIntervals(events) { var intervals = []; for (var i = 1; i < events.length; i++) intervals.push(events[i].time - events[i-1].time); return intervals; }
    function getCodonColor(codon) { return [175, 248, 273, 282, 245].includes(codon) ? '#f43f5e' : '#22d3ee'; }
    
    var darkLayout = { paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0.15)', font: { color: '#94a3b8', size: 11 }, margin: { t: 10, b: 40, l: 50, r: 20 }, xaxis: { gridcolor: 'rgba(255,255,255,0.05)' }, yaxis: { gridcolor: 'rgba(255,255,255,0.05)' } };
    
    function runMutationSimulation() {
      var lambda = parseFloat(lambdaInput.value), slope = parseFloat(slopeInput.value), maxTime = parseInt(timeInput.value);
      var eventsHom = generateHomogeneousPoisson(lambda, maxTime), eventsNHom = generateNonHomogeneousPoisson(lambda, slope, maxTime);
      
      document.getElementById('stat-hom-count').textContent = eventsHom.length;
      document.getElementById('stat-nhom-count').textContent = eventsNHom.length;
      var diff = ((eventsNHom.length - eventsHom.length) / eventsHom.length * 100).toFixed(1);
      document.getElementById('stat-diff').textContent = (diff > 0 ? '+' : '') + diff + '%';
      
      Plotly.newPlot('chart-mutations-hom', [{ x: eventsHom.map(e => e.time), y: eventsHom.map(e => e.codon), mode: 'markers', type: 'scatter', marker: { size: 6, color: eventsHom.map(e => getCodonColor(e.codon)), opacity: 0.7 } }], Object.assign({}, darkLayout, { xaxis: { ...darkLayout.xaxis, title: 'Tiempo (años)', range: [0, maxTime] }, yaxis: { ...darkLayout.yaxis, title: 'Codón', range: [0, 400] }, height: 260 }), { responsive: true });
      
      Plotly.newPlot('chart-mutations-nhom', [{ x: eventsNHom.map(e => e.time), y: eventsNHom.map(e => e.codon), mode: 'markers', type: 'scatter', marker: { size: 6, color: eventsNHom.map(e => getCodonColor(e.codon)), opacity: 0.7 } }], Object.assign({}, darkLayout, { xaxis: { ...darkLayout.xaxis, title: 'Tiempo (años)', range: [0, maxTime] }, yaxis: { ...darkLayout.yaxis, title: 'Codón', range: [0, 400] }, height: 260 }), { responsive: true });
      
      var cumHom = [], cumNHom = [], timePoints = [];
      for (var i = 0; i <= maxTime * 10; i++) { var t = i / 10; timePoints.push(t); cumHom.push(eventsHom.filter(e => e.time <= t).length); cumNHom.push(eventsNHom.filter(e => e.time <= t).length); }
      
      Plotly.newPlot('chart-cumulative', [
        { x: timePoints, y: cumHom, type: 'scatter', mode: 'lines', name: 'Homogéneo', line: { color: '#22d3ee', width: 3 }, fill: 'tozeroy', fillcolor: 'rgba(34,211,238,0.1)' },
        { x: timePoints, y: cumNHom, type: 'scatter', mode: 'lines', name: 'No Homogéneo', line: { color: '#f43f5e', width: 3 }, fill: 'tozeroy', fillcolor: 'rgba(244,63,94,0.1)' }
      ], Object.assign({}, darkLayout, { xaxis: { ...darkLayout.xaxis, title: 'Tiempo (años)' }, yaxis: { ...darkLayout.yaxis, title: 'N(t) Acumuladas' }, height: 300, showlegend: true, legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(0,0,0,0.5)' } }), { responsive: true });
      
      var intervalsHom = getIntervals(eventsHom), intervalsNHom = getIntervals(eventsNHom);
      Plotly.newPlot('chart-intervals-hom', [{ x: intervalsHom, type: 'histogram', nbinsx: 20, marker: { color: '#22d3ee' } }], Object.assign({}, darkLayout, { xaxis: { ...darkLayout.xaxis, title: 'Intervalo (años)' }, yaxis: { ...darkLayout.yaxis, title: 'Frecuencia' }, height: 220 }), { responsive: true });
      Plotly.newPlot('chart-intervals-nhom', [{ x: intervalsNHom, type: 'histogram', nbinsx: 20, marker: { color: '#f43f5e' } }], Object.assign({}, darkLayout, { xaxis: { ...darkLayout.xaxis, title: 'Intervalo (años)' }, yaxis: { ...darkLayout.yaxis, title: 'Frecuencia' }, height: 220 }), { responsive: true });
    }
    
    runBtn.addEventListener('click', runMutationSimulation);
    lambdaInput.addEventListener('change', runMutationSimulation);
    slopeInput.addEventListener('change', runMutationSimulation);
    timeInput.addEventListener('change', runMutationSimulation);
    runMutationSimulation();
  });
</script>

<script is:inline>
  // Simulador de Proceso de Poisson Compuesto
  document.addEventListener("DOMContentLoaded", function() {
    var lambdaCompInput = document.getElementById('comp-lambda');
    var muInput = document.getElementById('comp-mu');
    var timeCompInput = document.getElementById('comp-time');
    var runCompBtn = document.getElementById('comp-run');
    
    function updateCompLabels() {
      document.getElementById('comp-lambda-val').textContent = lambdaCompInput.value + ' tumores/u.t.';
      document.getElementById('comp-mu-val').textContent = parseFloat(muInput.value).toFixed(2);
      document.getElementById('comp-time-val').textContent = timeCompInput.value + ' u.t.';
    }
    lambdaCompInput.addEventListener('input', updateCompLabels);
    muInput.addEventListener('input', updateCompLabels);
    timeCompInput.addEventListener('input', updateCompLabels);
    
    // Generar número de mutaciones por tumor (geométrica desplazada para simular datos reales)
    function generateMutationsPerTumor(meanMuts) {
      // Usar distribución geométrica modificada (84% prob de 1, resto distribuido)
      var r = Math.random();
      if (r < 0.84) return 1;
      else if (r < 0.96) return 2;
      else if (r < 0.98) return 3;
      else if (r < 0.99) return 4;
      else return Math.floor(Math.random() * 4) + 5;
    }
    
    function generateCompoundPoisson(lambda, muX, maxTime) {
      var tumors = [];
      var totalMuts = 0;
      var t = 0;
      
      while (t < maxTime) {
        t += -Math.log(Math.random()) / lambda;
        if (t < maxTime) {
          var muts = generateMutationsPerTumor(muX);
          tumors.push({ time: t, mutations: muts });
          totalMuts += muts;
        }
      }
      return { tumors: tumors, totalMutations: totalMuts };
    }
    
    var darkLayout = {
      paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0.15)',
      font: { color: '#94a3b8', size: 11 },
      margin: { t: 10, b: 40, l: 50, r: 20 },
      xaxis: { gridcolor: 'rgba(255,255,255,0.05)' },
      yaxis: { gridcolor: 'rgba(255,255,255,0.05)' }
    };
    
    function runCompoundSimulation() {
      var lambda = parseFloat(lambdaCompInput.value);
      var muX = parseFloat(muInput.value);
      var maxTime = parseInt(timeCompInput.value);
      
      var result = generateCompoundPoisson(lambda, muX, maxTime);
      var tumors = result.tumors;
      var totalMuts = result.totalMutations;
      var expectedS = lambda * maxTime * muX;
      
      document.getElementById('stat-tumors').textContent = tumors.length;
      document.getElementById('stat-total-muts').textContent = totalMuts;
      document.getElementById('stat-expected').textContent = expectedS.toFixed(0);
      
      // Gráfico de proceso acumulado
      var timePoints = [];
      var cumTumors = [];
      var cumMuts = [];
      
      for (var i = 0; i <= maxTime * 10; i++) {
        var t = i / 10;
        timePoints.push(t);
        var nTumors = tumors.filter(tu => tu.time <= t).length;
        var sMuts = tumors.filter(tu => tu.time <= t).reduce((sum, tu) => sum + tu.mutations, 0);
        cumTumors.push(nTumors);
        cumMuts.push(sMuts);
      }
      
      // Línea teórica E[S(t)] = λt·μ
      var theoreticalS = timePoints.map(t => lambda * t * muX);
      
      Plotly.newPlot('chart-compound-cumulative', [
        { x: timePoints, y: cumTumors, type: 'scatter', mode: 'lines', name: 'N(t) Tumores', line: { color: '#22d3ee', width: 2 } },
        { x: timePoints, y: cumMuts, type: 'scatter', mode: 'lines', name: 'S(t) Mutaciones', line: { color: '#f43f5e', width: 3 } },
        { x: timePoints, y: theoreticalS, type: 'scatter', mode: 'lines', name: 'E[S(t)] = λt·μ', line: { color: '#a78bfa', width: 2, dash: 'dash' } }
      ], Object.assign({}, darkLayout, {
        xaxis: { ...darkLayout.xaxis, title: 'Tiempo' },
        yaxis: { ...darkLayout.yaxis, title: 'Conteo' },
        height: 320,
        showlegend: true,
        legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(0,0,0,0.5)' }
      }), { responsive: true });
      
      // Distribución de mutaciones por tumor (simulada)
      var mutsCounts = {};
      tumors.forEach(function(tu) {
        mutsCounts[tu.mutations] = (mutsCounts[tu.mutations] || 0) + 1;
      });
      var xMuts = Object.keys(mutsCounts).map(Number).sort((a,b) => a-b);
      var yFreq = xMuts.map(x => mutsCounts[x]);
      
      Plotly.newPlot('chart-compound-dist', [{
        x: xMuts, y: yFreq, type: 'bar',
        marker: { color: xMuts.map(x => x === 1 ? '#22d3ee' : '#f43f5e') },
        text: yFreq.map(f => f.toString()), textposition: 'outside'
      }], Object.assign({}, darkLayout, {
        xaxis: { ...darkLayout.xaxis, title: 'Mutaciones/Tumor', dtick: 1 },
        yaxis: { ...darkLayout.yaxis, title: 'Frecuencia' },
        height: 260
      }), { responsive: true });
    }
    
    // Gráfico de datos reales de complejidad
    function plotRealComplexity() {
      var data = window.datosCompuesto;
      if (!data) return;
      
      var comp = data.complejidad;
      Plotly.newPlot('chart-real-complexity', [{
        labels: comp.map(c => c.tipo),
        values: comp.map(c => c.porcentaje),
        type: 'pie',
        marker: { colors: ['#22d3ee', '#f43f5e', '#a78bfa', '#fbbf24'] },
        textinfo: 'label+percent',
        hole: 0.4
      }], Object.assign({}, darkLayout, {
        height: 260,
        showlegend: false,
        annotations: [{ text: '84%<br>Simple', x: 0.5, y: 0.5, font: { size: 14, color: '#22d3ee' }, showarrow: false }]
      }), { responsive: true });
    }
    
    // KaTeX para fórmulas del compuesto
    function renderCompoundFormulas() {
      if (typeof katex === 'undefined') { setTimeout(renderCompoundFormulas, 100); return; }
      var formulaES = document.getElementById('formula-es');
      var formulaVar = document.getElementById('formula-var');
      if (formulaES) katex.render('E[S(t)] = \\lambda t \\cdot E[X]', formulaES, { displayMode: false, throwOnError: false });
      if (formulaVar) katex.render('Var[S(t)] = \\lambda t \\cdot E[X^2]', formulaVar, { displayMode: false, throwOnError: false });
    }
    
    runCompBtn.addEventListener('click', runCompoundSimulation);
    lambdaCompInput.addEventListener('change', runCompoundSimulation);
    muInput.addEventListener('change', runCompoundSimulation);
    timeCompInput.addEventListener('change', runCompoundSimulation);
    
    runCompoundSimulation();
    plotRealComplexity();
    renderCompoundFormulas();
  });
</script>

<style>
  /* Animación Gen TP53 */
  .gene-anim-section {
    margin-top: 40px;
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 28px;
    background: linear-gradient(135deg, rgba(34,211,238,0.03), rgba(167,139,250,0.02));
  }
  
  .gene-anim-wrapper {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  
  .gene-params {
    text-align: center;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 15px;
    color: var(--muted);
    padding: 10px;
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
    border: 1px solid var(--border);
  }
  
  #gene-canvas {
    display: block;
    width: 100%;
    max-width: 900px;
    height: auto;
    margin: 0 auto;
    border-radius: 16px;
    border: 1px solid var(--border);
  }
  
  .gene-legend {
    display: flex;
    justify-content: center;
    gap: 24px;
    flex-wrap: wrap;
    font-size: 13px;
    color: var(--muted);
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
  }
  
  .legend-dot.hotspot { background: #f43f5e; }
  .legend-dot.normal { background: #3b82f6; }
  .legend-dot.mutation { background: #22d3ee; }
  
  .gene-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
  }
  
  .gene-controls .slider-group {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
  }
  
  .gene-controls .slider-group label {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    padding: 10px 16px;
    border-radius: 10px;
    font-size: 13px;
    color: var(--muted);
  }
  
  .gene-controls .slider-group input[type="range"] {
    width: 80px;
    accent-color: #22d3ee;
  }
  
  .gene-controls .slider-val {
    font-weight: 700;
    color: #22d3ee;
    font-family: 'JetBrains Mono', monospace;
    min-width: 35px;
    text-align: right;
  }
  
  .gene-btns {
    display: flex;
    gap: 10px;
  }
  
  .gene-btns .btn-start {
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    background: #22d3ee;
    color: #000;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
  }
  
  .gene-btns .btn-start:hover {
    background: #67e8f9;
    box-shadow: 0 4px 15px rgba(34,211,238,0.3);
  }
  
  .gene-btns .btn-start.active {
    background: #f43f5e;
  }
  
  .gene-btns .btn-reset {
    padding: 10px 16px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
  }
  
  .gene-btns .btn-reset:hover {
    border-color: #22d3ee;
    color: #22d3ee;
  }
  
  .gene-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
  }
  
  .gstat {
    background: rgba(0,0,0,0.2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px;
    text-align: center;
  }
  
  .gstat.hotspot {
    border-color: rgba(244,63,94,0.3);
    background: rgba(244,63,94,0.05);
  }
  
  .gstat-label {
    display: block;
    font-size: 11px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }
  
  .gstat-value {
    display: block;
    font-size: 20px;
    font-weight: 700;
    color: #22d3ee;
    font-family: 'JetBrains Mono', monospace;
  }
  
  .gstat.hotspot .gstat-value {
    color: #f43f5e;
  }
  
  @media (max-width: 800px) {
    .gene-controls {
      flex-direction: column;
      align-items: stretch;
    }
    .gene-controls .slider-group {
      flex-direction: column;
    }
    .gene-btns {
      justify-content: center;
    }
    .gene-stats {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .hero { margin-top: 40px; padding: clamp(24px,5vw,48px); border: 1px solid var(--border); border-radius: 24px; background: linear-gradient(135deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01)); display: grid; grid-template-columns: 1.2fr 1fr; gap: clamp(20px,4vw,32px); box-shadow: var(--shadow); }
  .hero__copy h1 { font-size: clamp(26px,3.5vw,38px); margin-top: 8px; }
  .hero__copy .lede { margin: 12px 0 18px; max-width: 600px; color: var(--muted); }
  .hero__panel { border: 1px solid var(--border); border-radius: 18px; background: linear-gradient(160deg, var(--surface), var(--surface-2)); padding: 18px; display: grid; gap: 12px; }
  .panel__header { display: flex; justify-content: space-between; align-items: center; }
  .chip, .bubble { padding: 6px 12px; border-radius: 10px; background: rgba(34,211,238,0.1); color: var(--accent); font-weight: 700; font-size: 12px; }
  .bubble.ghost { background: rgba(255,255,255,0.04); color: var(--muted); border: 1px solid var(--border); }
  .status { color: var(--ink); font-weight: 700; }
  .panel__list { display: grid; gap: 10px; }
  .panel__item { padding: 12px 14px; border-radius: 12px; border: 1px solid var(--border); background: rgba(255,255,255,0.02); }
  .panel__item .label { color: var(--muted); font-size: 12px; display: block; margin-bottom: 4px; }
  .panel__item p.warning { color: var(--warning); }
  .panel__footer { display: flex; gap: 10px; flex-wrap: wrap; }

  .simulator { margin-top: 40px; border: 1px solid var(--border); border-radius: 24px; padding: 28px; background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); }
  .sim-container { display: grid; gap: 24px; }
  .sim-controls { display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 16px; border: 1px solid var(--border); }
  .control-group { display: flex; flex-direction: column; gap: 6px; min-width: 160px; flex: 1; }
  .control-group label { font-size: 12px; color: var(--muted); font-weight: 600; }
  .control-group input[type="range"] { width: 100%; accent-color: var(--accent); }
  .control-group span { font-size: 13px; font-weight: 700; color: var(--accent); text-align: center; background: rgba(34,211,238,0.1); padding: 4px 8px; border-radius: 6px; }
  .sim-btn { padding: 14px 28px; border-radius: 12px; border: none; background: linear-gradient(120deg, var(--accent), var(--accent-2)); color: #0c0f1a; font-weight: 700; cursor: pointer; transition: all 0.2s; font-size: 14px; display: flex; align-items: center; gap: 8px; }
  .sim-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(34,211,238,0.4); }
  .sim-btn.pulse { animation: pulse 2s infinite; }
  @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(34,211,238,0.4); } 50% { box-shadow: 0 0 0 10px rgba(34,211,238,0); } }
  .btn-icon { font-size: 18px; }
  
  .sim-stats { display: flex; gap: 16px; flex-wrap: wrap; }
  .stat-box { flex: 1; min-width: 140px; padding: 16px; border-radius: 14px; text-align: center; border: 1px solid var(--border); background: rgba(0,0,0,0.2); }
  .stat-box.hom { border-color: var(--accent); background: linear-gradient(135deg, rgba(34,211,238,0.1), rgba(34,211,238,0.02)); }
  .stat-box.nhom { border-color: var(--danger); background: linear-gradient(135deg, rgba(244,63,94,0.1), rgba(244,63,94,0.02)); }
  .stat-box.diff { border-color: var(--accent-2); background: linear-gradient(135deg, rgba(167,139,250,0.1), rgba(167,139,250,0.02)); }
  .stat-label { display: block; font-size: 11px; color: var(--muted); text-transform: uppercase; }
  .stat-value { display: block; font-size: 32px; font-weight: 700; font-family: "Space Grotesk", sans-serif; }
  .stat-box.hom .stat-value { color: var(--accent); }
  .stat-box.nhom .stat-value { color: var(--danger); }
  .stat-box.diff .stat-value { color: var(--accent-2); }
  .stat-unit { display: block; font-size: 11px; color: var(--muted); }
  
  .sim-charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .chart-box { padding: 16px; background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 16px; }
  .chart-box.wide { grid-column: span 2; }
  .chart-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
  .chart-header.hom { border-color: var(--accent); }
  .chart-header.nhom { border-color: var(--danger); }
  .chart-header.comparison { border-color: var(--accent-2); }
  .chart-dot { width: 10px; height: 10px; border-radius: 50%; }
  .chart-header.hom .chart-dot { background: var(--accent); box-shadow: 0 0 8px var(--accent); }
  .chart-header.nhom .chart-dot { background: var(--danger); box-shadow: 0 0 8px var(--danger); }
  .chart-header h4 { margin: 0; font-size: 14px; color: var(--ink); }
  .chart-icon { font-size: 16px; }
  .mutation-chart { width: 100%; min-height: 260px; }
  .mutation-chart.tall { min-height: 300px; }
  
  .sim-formulas { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .formula-box { padding: 20px; border: 1px solid var(--border); border-radius: 14px; background: rgba(0,0,0,0.2); }
  .formula-box.hom-box { border-color: var(--accent); background: linear-gradient(135deg, rgba(34,211,238,0.06), transparent); }
  .formula-box.nhom-box { border-color: var(--danger); background: linear-gradient(135deg, rgba(244,63,94,0.06), transparent); }
  .formula-box h5 { margin: 0 0 12px; font-size: 14px; }
  .formula-box.hom-box h5 { color: var(--accent); }
  .formula-box.nhom-box h5 { color: var(--danger); }
  .formula-content { font-size: 18px; text-align: center; padding: 12px 0; }

  .charts-section { margin-top: 40px; }
  .charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
  .chart-card { padding: 20px; border: 1px solid var(--border); border-radius: 18px; background: rgba(255,255,255,0.02); }
  .chart-card.wide { grid-column: span 2; }
  .chart-card h4 { margin: 0 0 12px; font-size: 16px; }

  .analysis { margin-top: 40px; }
  .analysis-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
  .analysis-card { padding: 20px; border: 1px solid var(--border); border-radius: 18px; background: rgba(255,255,255,0.02); }
  .analysis-card.highlight { border-color: var(--accent); background: linear-gradient(135deg, rgba(34,211,238,0.06), rgba(167,139,250,0.04)); }
  .analysis-card.warning { border-color: var(--warning); }
  .card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
  .module-num { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: linear-gradient(120deg, var(--accent), var(--accent-2)); color: #0c0f1a; font-weight: 700; border-radius: 8px; font-size: 12px; }
  .card-header h4 { margin: 0; font-size: 16px; }
  .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .data-table td { padding: 8px 0; border-bottom: 1px solid var(--border); }
  .data-table td:first-child { color: var(--muted); }
  .data-table td.val { text-align: right; font-weight: 600; color: var(--ink); }
  .param-box { text-align: center; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-bottom: 16px; }
  .param-label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px; }
  .param-value { display: block; font-size: 28px; font-weight: 700; color: var(--accent); font-family: "Space Grotesk", sans-serif; }
  .param-ci { display: block; font-size: 12px; color: var(--muted); margin-top: 4px; }
  .param-row { display: flex; gap: 12px; }
  .param-item { flex: 1; text-align: center; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px; border: 1px solid var(--border); }
  .param-item.accent { border-color: var(--accent); background: rgba(34,211,238,0.1); }
  .param-item .label { display: block; font-size: 11px; color: var(--muted); }
  .param-item .value { display: block; font-size: 18px; font-weight: 700; color: var(--ink); margin-top: 4px; }
  .validation-grid { display: flex; gap: 12px; margin-bottom: 16px; }
  .val-metric { flex: 1; text-align: center; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px; }
  .val-metric.big { flex: 1.5; }
  .val-metric.warning { border: 1px solid var(--warning); background: rgba(245,158,11,0.1); }
  .metric-label { display: block; font-size: 11px; color: var(--muted); }
  .metric-value { display: block; font-size: 18px; font-weight: 700; color: var(--ink); margin-top: 4px; }
  .val-metric.warning .metric-value { color: var(--warning); }
  .conclusion { padding: 12px; border-radius: 10px; font-size: 13px; background: rgba(34,211,238,0.08); border: 1px solid var(--accent); }
  .conclusion.warning { background: rgba(245,158,11,0.1); border-color: var(--warning); }
  .model-box { text-align: center; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-bottom: 16px; }
  .model-label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 8px; }
  .model-formula { font-size: 20px; }

  /* Proceso Compuesto */
  .compound-section { margin-top: 40px; border: 1px solid var(--border); border-radius: 24px; padding: 28px; background: linear-gradient(135deg, rgba(167,139,250,0.05), rgba(244,63,94,0.03)); }
  .compound-container { display: grid; gap: 24px; }
  .compound-controls { display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 16px; border: 1px solid rgba(167,139,250,0.3); }
  .compound-btn { background: linear-gradient(120deg, #a78bfa, #f43f5e) !important; }
  .compound-btn:hover { box-shadow: 0 8px 24px rgba(167,139,250,0.4) !important; }
  
  .compound-stats { display: flex; gap: 16px; flex-wrap: wrap; }
  .stat-box.tumors { border-color: #22d3ee; background: linear-gradient(135deg, rgba(34,211,238,0.1), rgba(34,211,238,0.02)); }
  .stat-box.tumors .stat-value { color: #22d3ee; }
  .stat-box.mutations { border-color: #f43f5e; background: linear-gradient(135deg, rgba(244,63,94,0.1), rgba(244,63,94,0.02)); }
  .stat-box.mutations .stat-value { color: #f43f5e; }
  .stat-box.expected { border-color: #a78bfa; background: linear-gradient(135deg, rgba(167,139,250,0.1), rgba(167,139,250,0.02)); }
  .stat-box.expected .stat-value { color: #a78bfa; }
  
  .compound-charts { display: grid; gap: 20px; }
  .compound-wide { }
  .compound-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .compound-header { border-color: #a78bfa !important; }
  
  .compound-theory { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .theory-box { padding: 20px; border: 1px solid rgba(167,139,250,0.4); border-radius: 14px; background: rgba(167,139,250,0.08); }
  .theory-box h5 { margin: 0 0 16px; color: #a78bfa; font-size: 14px; }
  .formula-grid { display: grid; gap: 12px; }
  .formula-item { display: flex; align-items: center; gap: 12px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; }
  .formula-label { font-size: 12px; color: var(--muted); min-width: 70px; }
  .formula-eq { font-size: 16px; color: var(--ink); }
  
  .real-data-box { padding: 20px; border: 1px solid rgba(244,63,94,0.4); border-radius: 14px; background: rgba(244,63,94,0.06); }
  .real-data-box h5 { margin: 0 0 16px; color: #f43f5e; font-size: 14px; }
  .real-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
  .real-item { padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; text-align: center; border: 1px solid var(--border); }
  .real-item.accent { border-color: #22d3ee; background: rgba(34,211,238,0.1); }
  .real-item .label { display: block; font-size: 11px; color: var(--muted); }
  .real-item .value { display: block; font-size: 16px; font-weight: 700; color: var(--ink); margin-top: 2px; }

  @media (max-width: 900px) {
    .hero { grid-template-columns: 1fr; }
    .sim-charts-grid, .sim-formulas, .charts-grid, .analysis-grid, .compound-grid, .compound-theory { grid-template-columns: 1fr; }
    .chart-box.wide, .chart-card.wide { grid-column: span 1; }
  }
</style>
