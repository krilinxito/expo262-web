---
import BaseLayout from '../../components/BaseLayout.astro';
import Topbar from '../../components/Topbar.astro';
import Hero from '../../components/Hero.astro';
import InformeCarousel from '../../components/InformeCarousel.astro';
import CodeSection from '../../components/CodeSection.astro';
import Footer from '../../components/Footer.astro';

const informeSlides = [
  { section: "Portada", title: "Modelos de Colas M/M/c en la Nube", subtitle: "Evaluaci√≥n de Rendimiento y Asignaci√≥n de Recursos", bullets: ["Grupo G42 ¬∑ Noviembre 2025", "Procesos Estoc√°sticos y Series de Tiempo", "Universidad Mayor de San Andr√©s"], image: "https://bernardmarr.com/img/The%205%20Biggest%20Cloud%20Computing%20Trends%20In%202021.jpg" },
  { section: "Introducci√≥n", title: "Contexto del Problema", bullets: ["AWS, Azure y Google Cloud: $591 mil millones en 2023", "Black Friday: peticiones aumentan exponencialmente", "Colas largas ‚Üí tiempos lentos ‚Üí abandono de carritos", "M/M/c simula escenarios para optimizar costo vs eficiencia"], image: "https://www.megaport.com/images/blog/covers/aws-azure-google-cloud-the-big-three-compared_hu_11573b93c75ecdd9.webp" },
  { section: "Problema", title: "Pregunta de Investigaci√≥n", highlight: true, bullets: ["¬øC√≥mo determinar el n√∫mero √≥ptimo de instancias virtuales?", "Minimizar Wq (tiempo en cola) y Lq (longitud de cola)", "Controlar costo operativo simult√°neamente", "Con llegadas Poisson(Œª) y servicios Exp(Œº)"], image: "https://www.shutterstock.com/image-vector/trendy-halftone-collage-problem-solving-600nw-2610919851.jpg" },
  { section: "Marco Te√≥rico", title: "Proceso de Poisson y Exponencial", bullets: ["N(t) = eventos hasta tiempo t, incremens", "Inter-llegada ~ Exp(Œª), tiempo servicio ~ Exp(Œº)", "Propiedad sin memoria: P(T > t+s | T > s) = P(T > t)", "Base para modelar llegadas HTTP y tiempos de procesamiento"], image: "https://www.scribbr.nl/wp-content/uploads/2022/08/Poisson-distribution-graph.webp" },
  { section: "Marco Te√≥rico", title: "Modelo M/M/c ¬∑ F√≥rmulas", highlight: true, isFormula: true, bullets: ["œÅ = Œª/(cŒº) < 1 ‚Üí condici√≥n de estabilidad", "P‚ÇÄ = [Œ£(r^k/k!) + r^c/(c!(1-œÅ))]‚Åª¬π", "Lq = P‚ÇÄ¬∑r^c¬∑œÅ / (c!(1-œÅ)¬≤)", "Wq = Lq/Œª ; W = Wq + 1/Œº ; L = ŒªW"], image: "https://upload.wikimedia.org/wikipedia/commons/d/de/M-m-c_queue.png" },
  { section: "Metodolog√≠a", title: "Dise√±o del Experimento", bullets: ["Python + SimPy para simulaci√≥n discreta de eventos", "Streamlit para interfaz web interactiva", "Base: Œª=120, Œº=30, c=1..20, tiempo=600s", "Sensibilidad: variar Œª, Œº, costos para an√°lisis de trade-offs"], image: "https://i.ytimg.com/vi/GQ85Gc1s_Fg/maxresdefault.jpg" },
  { section: "Resultados", title: "Resultados de Simulaci√≥n", bullets: ["c=4: œÅ=1.00 (inestable), Lq ‚Üí ‚àû", "c=6: œÅ=0.67, Lq ‚âà 0.15, Wq ‚âà 0.001s ‚Üí estable", "c=8: œÅ=0.50, muy holgado pero costoso", "Punto √≥ptimo: c=5-6 donde Wq < 0.01s"], image: "https://media.tenor.com/l-PbZelgds0AAAAM/favorite-facts.gif" },
  { section: "Conclusiones", title: "Conclusiones", bullets: ["M/M/c es robusto para optimizar recursos cloud", "Mantener œÅ < 0.8 para resiliencia ante picos", "Trade-off costo-rendimiento: diminishing returns con m√°s servidores", "Simulaci√≥n valida bien la teor√≠a en sistemas estables"], image: "https://cdn.prod.website-files.com/643d2eea03135260bdaca209/6585cea39ae01230757b9f31_QuantumCloud.webp" },
  { section: "Aplicaciones", title: "Aplicaciones Pr√°cticas", bullets: ["AWS CloudWatch para autoscaling predictivo", "E-commerce: modelar tr√°fico Black Friday", "IoT: manejar colas de sensores en tiempo real", "Fintech/Healthcare: donde colas impactan tiempos cr√≠ticos"], image: "https://cdn.prod.website-files.com/62fec8041edae129b05e72ac/659e054b003ea5f343dec334_Blog-HeroImage-Optimizing-Images-for-Page-Speed-1600x900px.png" }
];

const codeFiles = [
  {
    filename: "simulator.py",
    description: "Motor de simulaci√≥n M/M/c con SimPy",
    code: `# simulator.py
import simpy
import random
import numpy as np
import math

def run_simulation(lambda_rate, mu_rate, num_servers, sim_time=600, seed=42):
    random.seed(seed)
    np.random.seed(seed)
    
    arrivals, queue_lengths, wait_times = [], [], []

    def arrival(env, servers):
        while True:
            yield env.timeout(random.expovariate(lambda_rate))
            arrivals.append(env.now)
            env.process(customer(env, servers))
    
    def customer(env, servers):
        arrive = env.now
        with servers.request() as req:
            queue_lengths.append(len(servers.queue))
            yield req
            wait_times.append(env.now - arrive)
            yield env.timeout(random.expovariate(mu_rate))
    
    env = simpy.Environment()
    servers = simpy.Resource(env, capacity=num_servers)
    env.process(arrival(env, servers))
    env.run(until=sim_time)

    # === C√ÅLCULO TE√ìRICO (Erlang-C) ===
    rho = lambda_rate / (num_servers * mu_rate)
    if rho < 1:
        r = lambda_rate / mu_rate
        sum_term = sum(r**k / math.factorial(k) for k in range(num_servers))
        P0 = 1 / (sum_term + r**num_servers / (math.factorial(num_servers) * (1-rho)))
        Lq = P0 * (r**num_servers) * rho / (math.factorial(num_servers) * (1-rho)**2)
        Wq = Lq / lambda_rate
    else:
        Lq = Wq = float('inf')

    return dict(rho=rho, Lq_theory=Lq, Wq_theory=Wq,
                Lq_sim=np.mean(queue_lengths), Wq_sim=np.mean(wait_times))`
  },
  {
    filename: "app.py",
    description: "Interfaz web con Streamlit y Plotly",
    code: "# app.py - Cloud Queue Simulator M/M/c\nimport streamlit as st\nimport numpy as np\nimport pandas as pd\nimport plotly.express as px\nfrom simulator import run_simulation\n\nst.set_page_config(page_title=\"Cloud Queue Simulator\", layout=\"wide\")\n\nwith st.sidebar:\n    lambda_rate = st.slider(\"Tasa de llegada\", 10, 400, 120)\n    mu_rate = st.slider(\"Tasa de servicio\", 10, 100, 30)\n    num_servers = st.slider(\"Servidores (c)\", 1, 40, 6)\n    sim_time = st.slider(\"Duracion (s)\", 120, 1800, 600)\n    costo = st.number_input(\"Costo/servidor ($)\", 10, 2000, 120)\n\nresults = run_simulation(lambda_rate, mu_rate, num_servers, sim_time)\n\n# Metricas\nc1, c2, c3, c4 = st.columns(4)\nc1.metric(\"Utilizacion\", f\"{results['rho']:.1%}\")\nc2.metric(\"Tiempo en cola\", f\"{results['Wq_sim']:.3f} s\")\nc3.metric(\"Cola promedio\", f\"{results['Lq_sim']:.1f}\")\nc4.metric(\"Costo mensual\", f\"${num_servers * costo}\")\n\n# Grafico de cola\ndf = pd.DataFrame({\n    'Tiempo': np.linspace(0, sim_time, 100),\n    'Cola': results.get('queue_lengths', [])\n})\nfig = px.area(df, x='Tiempo', y='Cola', template=\"plotly_dark\")\nst.plotly_chart(fig, use_container_width=True)"
  }
];
---

<BaseLayout 
  title="Proyecto 13 ¬∑ Modelos de colas en servicios en la nube (M/M/c)" 
  description="Evaluaci√≥n de rendimiento y asignaci√≥n de recursos con llegadas Poisson, servicios exponenciales y m√∫ltiples servidores."
  accentColor="#8ad6ff"
  accentColor2="#72f0d5"
>
  <Topbar 
    brandText="Proyecto 13 ¬∑ M/M/c"
    links={[
      { href: "/", text: "Home" },
      { href: "#informe", text: "Informe" },
      { href: "#animacion", text: "Animaci√≥n" },
      { href: "#sim", text: "Simulador" },
      { href: "#codigo", text: "C√≥digo Python" }
    ]}
  />

      <main>
    <Hero
      eyebrow="Tema 13"
      title="Modelos de colas en servicios en la nube (M/M/c)"
      description="Evaluaci√≥n de rendimiento y asignaci√≥n de recursos con llegadas Poisson, servicios exponenciales y m√∫ltiples servidores. Integra teor√≠a, simulaci√≥n y visualizaciones interactivas."
      tags={["Œª/Œº ¬∑ Erlang-C", "SimPy + Streamlit", "Cloud scaling"]}
      primaryBtn={{ href: "#sim", text: "Simulador M/M/c" }}
      secondaryBtn={{ href: "#informe", text: "Ver presentaci√≥n" }}
      panelStatus="Preparado"
      panelItems={[
        { label: "Asignatura", value: "Procesos Estoc√°sticos y Series de Tiempo" },
        { label: "Modelo", value: "M/M/c ¬∑ Poisson(Œª), Exp(Œº), c servidores" },
        { label: "Herramientas", value: "SimPy ¬∑ Streamlit ¬∑ Plotly ¬∑ NumPy/Pandas" }
      ]}
      panelFooterTags={["Grupo 42", "Colas ¬∑ Cloud"]}
    />

    <InformeCarousel slides={informeSlides} id="informe" />

    <!-- ANIMACI√ìN VISUAL M/M/c -->
    <section class="anim-section" id="animacion">
      <div class="section__head">
        <div>
          <p class="eyebrow">Visualizaci√≥n Interactiva</p>
          <h2>Modelo M/M/c</h2>
          <p class="section__lede">Observa c√≥mo m√∫ltiples servidores atienden clientes en paralelo.</p>
            </div>
            </div>

      <div class="anim-wrapper">
        <div class="anim-params">
          <span id="anim-params-text">Œª = 2.00, Œº = 1.00, c = 3, œÅ = 0.67</span>
          </div>
        
        <canvas id="mmc-canvas" width="750" height="380"></canvas>
        
        <div class="anim-controls">
          <div class="slider-group">
            <label>
              <span>Œª (llegadas/s)</span>
              <input type="range" id="anim-lambda" min="0.5" max="5" step="0.25" value="2" />
              <span class="slider-val" id="anim-lambda-val">2.00</span>
            </label>
            <label>
              <span>Œº (servicio/s)</span>
              <input type="range" id="anim-mu" min="0.3" max="2" step="0.1" value="1" />
              <span class="slider-val" id="anim-mu-val">1.00</span>
            </label>
            <label>
              <span>c (servidores)</span>
              <input type="range" id="anim-servers" min="1" max="6" step="1" value="3" />
              <span class="slider-val" id="anim-servers-val">3</span>
            </label>
            </div>
          <div class="anim-btns">
            <button id="anim-start" class="btn-start">‚ñ∂ Iniciar</button>
            <button id="anim-reset" class="btn-reset">‚Ü∫ Reset</button>
              </div>
              </div>
          </div>
        </section>

        <!-- SIMULADOR M/M/c -->
        <section class="sim" id="sim">
          <div class="section__head">
            <div>
              <p class="eyebrow">Interactivo</p>
              <h2>Simulador M/M/c con JavaScript</h2>
              <p class="section__lede">Ajusta par√°metros, ejecuta la simulaci√≥n real en el navegador y analiza escalabilidad y costo.</p>
            </div>
          </div>

          <div class="sim-grid">
            <div class="controls">
          <label>Œª (llegadas/s)<input type="range" id="lambda" min="10" max="400" step="10" value="120" /><span class="value" id="lambda-value">120</span></label>
          <label>Œº (servicio por servidor)<input type="range" id="mu" min="5" max="120" step="5" value="30" /><span class="value" id="mu-value">30</span></label>
          <label>c (servidores)<input type="range" id="servers" min="1" max="40" step="1" value="6" /><span class="value" id="servers-value">6</span></label>
          <label>Tiempo de simulaci√≥n (s)<input type="range" id="time" min="100" max="2000" step="50" value="600" /><span class="value" id="time-value">600</span></label>
          <label>Costo/servidor (USD/mes)<input type="range" id="cost" min="50" max="1500" value="300" /><span class="value" id="cost-value">300</span></label>
            </div>

            <div class="metrics">
          <div class="metric"><p>Utilizaci√≥n œÅ</p><h3 id="rho-out">0.00</h3><small id="stable-out">‚Äî</small></div>
          <div class="metric"><p>Wq (s) ¬∑ Tiempo en cola</p><h3 id="wq-out">0.00</h3></div>
          <div class="metric"><p>Lq ¬∑ Cola promedio</p><h3 id="lq-out">0.00</h3></div>
          <div class="metric"><p>Costo mensual (USD)</p><h3 id="cost-out">0</h3></div>
            </div>

            <div class="actions">
              <button id="run-sim" class="primary">Ejecutar simulaci√≥n</button>
              <button id="analyze" class="ghost">Analizar escalabilidad</button>
            </div>

        <div class="charts"><div id="queue-chart" style="width:100%;height:400px;"></div></div>

        <div id="analysis-wrapper" class="analysis-wrapper">
          <div id="analysis-loading" class="analysis-loading">
            <div class="loading-ring"><div></div><div></div><div></div><div></div></div>
            <p>Simulando configuraciones...</p>
            <div class="loading-progress"><div id="loading-bar" class="loading-bar"></div></div>
            </div>
          <div id="analysis-content" class="analysis-content">
            <div class="analysis-charts">
              <div class="analysis-chart-box"><h4>Impacto del N√∫mero de Servidores</h4><div id="scalability-chart"></div></div>
              <div class="analysis-chart-box"><h4>Trade-off: Costo vs Rendimiento</h4><div id="tradeoff-chart"></div></div>
          </div>
            <div class="analysis-results">
              <h4>Resultados Detallados</h4>
              <div id="analysis-table" class="analysis-table"></div>
              <div id="analysis-optimum" class="analysis-optimum"></div>
            </div>
            </div>
          </div>

        <div class="formula">
          <p class="eyebrow">F√≥rmulas clave</p>
          <div class="formula-list">
            <div class="formula-item"><span class="formula-label">Utilizaci√≥n:</span><span class="formula-math" id="f1"></span></div>
            <div class="formula-item"><span class="formula-label">Probabilidad sistema vac√≠o:</span><span class="formula-math" id="f2"></span></div>
            <div class="formula-item"><span class="formula-label">Longitud de cola:</span><span class="formula-math" id="f3"></span></div>
            <div class="formula-item"><span class="formula-label">Tiempos y relaciones:</span><span class="formula-math" id="f4"></span></div>
            </div>
            </div>
          </div>
        </section>

    <CodeSection
      title="Simulador Python ¬∑ Streamlit + SimPy"
      subtitle="El simulador interactivo de arriba es una <strong>r√©plica en JavaScript</strong> del c√≥digo Python original. Aqu√≠ est√° el c√≥digo fuente completo para ejecutar la versi√≥n con Streamlit."
      notice={{ icon: "üí°", text: "<strong>Nota:</strong> El simulador M/M/c que ves arriba en esta p√°gina est√° implementado en JavaScript puro, replicando la l√≥gica del c√≥digo Python. Ambas versiones usan las mismas f√≥rmulas de Erlang-C y simulaci√≥n de eventos discretos." }}
      files={codeFiles}
      runCommands={`# Instalar dependencias
pip install streamlit simpy numpy pandas plotly

# Ejecutar la app
cd "proy 13 (python)"
streamlit run app.py`}
    />
      </main>

  <Footer rightText="Proyecto 13 ¬∑ Modelos de colas M/M/c" />
</BaseLayout>

  <script is:inline>
// Animaci√≥n M/M/c estilo Manim
(function() {
  const canvas = document.getElementById('mmc-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  
  let lambda = 2, mu = 1, numServers = 3;
  let running = false;
  let balls = [];
  let servers = []; // { busy: false, ball: null }
  let served = 0;
  let nextArrival = 0;
  let simTime = 0;
  
  // Layout base
  const L = {
    queueX: 140,
    queueTopY: 80,
    queueSpacing: 40,
    serversStartX: 380,
    serversSpacingY: 85,
    serverW: 80,
    serverH: 65,
    exitX: 700,
    ballR: 15,
    arriveFromX: -40,
    arriveY: 80
  };
  
  function resizeCanvas() {
    // Calcular altura necesaria seg√∫n n√∫mero de servidores
    const minHeight = 350;
    const heightPerServer = L.serversSpacingY;
    const padding = 120;
    const neededHeight = Math.max(minHeight, numServers * heightPerServer + padding);
    canvas.height = neededHeight;
  }
  
  const colors = {
    bg: '#0d1117',
    grid: 'rgba(255,255,255,0.03)',
    text: '#8b949e',
    textBright: '#c9d1d9',
    ball: '#8ad6ff',
    serving: '#72f0d5',
    server: '#58a6ff',
    serverFill: 'rgba(88,166,255,0.1)',
    serverBusy: '#f0883e',
    exit: '#a371f7'
  };
  
    function randExp(rate) {
      return -Math.log(1 - Math.random()) / rate;
    }
  
  function lerp(a, b, t) {
    return a + (b - a) * Math.min(1, t);
  }
  
  function initServers() {
    servers = [];
    for (let i = 0; i < numServers; i++) {
      servers.push({ busy: false, ball: null });
    }
    resizeCanvas();
  }
  
  function getServerY(index) {
    const totalHeight = (numServers - 1) * L.serversSpacingY;
    const startY = (canvas.height - totalHeight) / 2;
    return startY + index * L.serversSpacingY;
  }
  
  function drawScene() {
    ctx.fillStyle = colors.bg;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Grid sutil
    ctx.strokeStyle = colors.grid;
    ctx.lineWidth = 1;
    for (let x = 0; x < canvas.width; x += 40) {
      ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
    }
    for (let y = 0; y < canvas.height; y += 40) {
      ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
    }
    
    // L√≠nea de cola (vertical)
    ctx.strokeStyle = 'rgba(138,214,255,0.3)';
    ctx.lineWidth = 2;
    ctx.setLineDash([6, 4]);
    ctx.beginPath();
    ctx.moveTo(L.queueX, L.queueTopY - 20);
    ctx.lineTo(L.queueX, L.queueTopY + 9 * L.queueSpacing);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Etiqueta cola
    ctx.fillStyle = colors.text;
    ctx.font = '11px Manrope, system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('COLA', L.queueX, L.queueTopY - 35);
    
    // Dibujar servidores
    for (let i = 0; i < numServers; i++) {
      const y = getServerY(i);
      const isBusy = servers[i] && servers[i].busy;
      
      // L√≠nea de conexi√≥n cola -> servidor
      ctx.strokeStyle = 'rgba(138,214,255,0.15)';
      ctx.lineWidth = 1;
      ctx.setLineDash([4, 4]);
      ctx.beginPath();
      ctx.moveTo(L.queueX + 30, L.queueTopY);
      ctx.lineTo(L.serversStartX - L.serverW/2, y);
      ctx.stroke();
      ctx.setLineDash([]);
      
      // Servidor
      ctx.strokeStyle = isBusy ? colors.serverBusy : colors.server;
      ctx.lineWidth = 2;
      ctx.strokeRect(L.serversStartX - L.serverW/2, y - L.serverH/2, L.serverW, L.serverH);
      ctx.fillStyle = isBusy ? 'rgba(240,136,62,0.1)' : colors.serverFill;
      ctx.fillRect(L.serversStartX - L.serverW/2, y - L.serverH/2, L.serverW, L.serverH);
      
      // Etiqueta servidor
      ctx.fillStyle = colors.text;
      ctx.font = '10px Manrope, system-ui, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(`S${i + 1}`, L.serversStartX, y + L.serverH/2 + 15);
      
      // Estado
      ctx.font = 'bold 9px Manrope, system-ui, sans-serif';
      ctx.fillStyle = isBusy ? colors.serverBusy : colors.server;
      ctx.fillText(isBusy ? 'OCUPADO' : 'LIBRE', L.serversStartX, y - L.serverH/2 - 8);
    }
    
    // Contador atendidos
    ctx.font = '12px Manrope, system-ui, sans-serif';
    ctx.fillStyle = colors.textBright;
    ctx.textAlign = 'right';
    ctx.fillText(`Atendidos: ${served}`, canvas.width - 15, canvas.height - 15);
    
    // Cantidad en cola
    const inQueue = balls.filter(b => b.state === 'queue').length;
    ctx.textAlign = 'left';
    ctx.fillText(`En cola: ${inQueue}`, 15, canvas.height - 15);
    
    // Servidores ocupados
    const busyCount = servers.filter(s => s.busy).length;
    ctx.textAlign = 'center';
    ctx.fillText(`Servidores ocupados: ${busyCount}/${numServers}`, canvas.width / 2, canvas.height - 15);
  }
  
  function drawBall(b) {
    ctx.beginPath();
    ctx.arc(b.x, b.y, L.ballR, 0, Math.PI * 2);
    
    let color = colors.ball;
    if (b.state === 'serving') color = colors.serving;
    if (b.state === 'exiting') color = colors.exit;
    
    ctx.fillStyle = color;
    ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    // Progreso de servicio
    if (b.state === 'serving' && b.serviceProgress > 0) {
      ctx.beginPath();
      ctx.arc(b.x, b.y, L.ballR + 4, -Math.PI/2, -Math.PI/2 + b.serviceProgress * Math.PI * 2);
      ctx.strokeStyle = colors.server;
      ctx.lineWidth = 3;
      ctx.stroke();
    }
  }
  
  function updateBalls(dt) {
    balls.forEach(b => {
      if (b.state === 'arriving') {
        b.x = lerp(b.x, b.targetX, dt * 5);
        b.y = lerp(b.y, b.targetY, dt * 5);
        if (Math.abs(b.x - b.targetX) < 2 && Math.abs(b.y - b.targetY) < 2) {
          b.x = b.targetX;
          b.y = b.targetY;
          b.state = 'queue';
        }
      }
      
      if (b.state === 'queue') {
        b.targetY = L.queueTopY + b.queueIndex * L.queueSpacing;
        b.y = lerp(b.y, b.targetY, dt * 8);
      }
      
      if (b.state === 'toServer') {
        const serverY = getServerY(b.serverIndex);
        b.x = lerp(b.x, L.serversStartX, dt * 5);
        b.y = lerp(b.y, serverY, dt * 5);
        if (Math.abs(b.x - L.serversStartX) < 3 && Math.abs(b.y - serverY) < 3) {
          b.x = L.serversStartX;
          b.y = serverY;
          b.state = 'serving';
          b.serviceProgress = 0;
          b.serviceDuration = randExp(mu);
          servers[b.serverIndex].busy = true;
          servers[b.serverIndex].ball = b;
        }
      }
      
      if (b.state === 'serving') {
        b.serviceProgress += dt / b.serviceDuration;
        if (b.serviceProgress >= 1) {
          b.state = 'exiting';
          b.serviceProgress = 1;
          servers[b.serverIndex].busy = false;
          servers[b.serverIndex].ball = null;
          served++;
        }
      }
      
      if (b.state === 'exiting') {
        b.x = lerp(b.x, L.exitX + 100, dt * 4);
      }
    });
    
    // Remover bolitas que salieron
    balls = balls.filter(b => b.state !== 'exiting' || b.x < canvas.width + 50);
    
    // Recalcular √≠ndices de cola
    let idx = 0;
    balls.filter(b => b.state === 'queue').forEach(b => {
      b.queueIndex = idx++;
    });
    
    // Mover bolitas de la cola a servidores libres
    const firstInQueue = balls.find(b => b.state === 'queue' && b.queueIndex === 0);
    if (firstInQueue) {
      // Buscar servidor libre que no tenga a nadie yendo
      const someoneGoingToServer = (idx) => balls.some(b => b.state === 'toServer' && b.serverIndex === idx);
      
      for (let i = 0; i < servers.length; i++) {
        if (!servers[i].busy && !someoneGoingToServer(i)) {
          firstInQueue.state = 'toServer';
          firstInQueue.serverIndex = i;
          break;
        }
      }
    }
  }
  
  function spawnBall() {
    // Buscar servidor libre
    const freeServerIndex = servers.findIndex(s => !s.busy);
    const someoneGoingToThatServer = (idx) => balls.some(b => b.state === 'toServer' && b.serverIndex === idx);
    
    // Encontrar un servidor que est√© libre Y que nadie est√© yendo a √©l
    let targetServer = -1;
    for (let i = 0; i < servers.length; i++) {
      if (!servers[i].busy && !someoneGoingToThatServer(i)) {
        targetServer = i;
        break;
      }
    }
    
    if (targetServer !== -1) {
      // Ir directo al servidor
      balls.push({
        state: 'toServer',
        x: L.arriveFromX,
        y: L.arriveY,
        targetX: L.serversStartX,
        targetY: getServerY(targetServer),
        queueIndex: -1,
        serverIndex: targetServer,
        serviceProgress: 0,
        serviceDuration: 0
      });
    } else {
      // Todos ocupados, ir a la cola
      const queueCount = balls.filter(b => b.state === 'queue' || b.state === 'arriving').length;
      balls.push({
        state: 'arriving',
        x: L.arriveFromX,
        y: L.arriveY,
        targetX: L.queueX,
        targetY: L.queueTopY + queueCount * L.queueSpacing,
        queueIndex: queueCount,
        serverIndex: -1,
        serviceProgress: 0,
        serviceDuration: 0
      });
    }
  }
  
  let lastTime = 0;
  function loop(timestamp) {
    if (!running) return;
    
    const dt = lastTime ? (timestamp - lastTime) / 1000 : 0.016;
    lastTime = timestamp;
    
    simTime += dt;
    
    // Llegadas
    if (simTime >= nextArrival) {
      spawnBall();
      nextArrival = simTime + randExp(lambda);
    }
    
    updateBalls(dt);
    drawScene();
    balls.forEach(drawBall);
    
    requestAnimationFrame(loop);
  }
  
  function reset() {
    balls = [];
    served = 0;
    simTime = 0;
    nextArrival = randExp(lambda);
    lastTime = 0;
    initServers();
    drawScene();
  }
  
  function updateParamsText() {
    const rho = (lambda / (numServers * mu)).toFixed(2);
    document.getElementById('anim-params-text').textContent = 
      `Œª = ${lambda.toFixed(2)}, Œº = ${mu.toFixed(2)}, c = ${numServers}, œÅ = ${rho}`;
  }
  
  // Event listeners
  document.getElementById('anim-lambda').addEventListener('input', function(e) {
    lambda = parseFloat(e.target.value);
    document.getElementById('anim-lambda-val').textContent = lambda.toFixed(2);
    updateParamsText();
  });
  
  document.getElementById('anim-mu').addEventListener('input', function(e) {
    mu = parseFloat(e.target.value);
    document.getElementById('anim-mu-val').textContent = mu.toFixed(2);
    updateParamsText();
  });
  
  document.getElementById('anim-servers').addEventListener('input', function(e) {
    numServers = parseInt(e.target.value);
    document.getElementById('anim-servers-val').textContent = numServers;
    initServers();
    updateParamsText();
    if (!running) {
      reset();
    }
  });
  
  document.getElementById('anim-start').addEventListener('click', function() {
    running = !running;
    this.textContent = running ? '‚è∏ Pausar' : '‚ñ∂ Iniciar';
    this.classList.toggle('active', running);
    if (running) {
      lastTime = 0;
      requestAnimationFrame(loop);
    }
  });
  
  document.getElementById('anim-reset').addEventListener('click', function() {
    running = false;
    document.getElementById('anim-start').textContent = '‚ñ∂ Iniciar';
    document.getElementById('anim-start').classList.remove('active');
    reset();
  });
  
  // Init
  initServers();
  reset();
  updateParamsText();
})();
</script>

  <script is:inline>
    // === Simulador M/M/c en JavaScript ===
  function factorial(n) { let r = 1; for (let i = 2; i <= n; i++) r *= i; return r; }
  function randExp(rate) { return -Math.log(1 - Math.random()) / rate; }

    function simulate(lambda, mu, c, simTime) {
    let t = 0, nextArrival = randExp(lambda), serviceEndTimes = [], queue = [], waitTimes = [], timeline = [[0, 0]];
      while (true) {
        const nextService = serviceEndTimes.length > 0 ? serviceEndTimes[0] : Infinity;
        if (nextArrival <= nextService && nextArrival <= simTime) {
          t = nextArrival;
        if (serviceEndTimes.length < c) { serviceEndTimes.push(t + randExp(mu)); serviceEndTimes.sort((a, b) => a - b); waitTimes.push(0); }
        else { queue.push(t); }
          nextArrival += randExp(lambda);
          timeline.push([t, queue.length]);
      } else if (nextService < nextArrival && nextService <= simTime) {
        t = nextService; serviceEndTimes.shift();
        if (queue.length > 0) { waitTimes.push(t - queue.shift()); serviceEndTimes.push(t + randExp(mu)); serviceEndTimes.sort((a, b) => a - b); }
          timeline.push([t, queue.length]);
      } else { break; }
        if (t > simTime) break;
      }
    if (timeline[timeline.length - 1][0] < simTime) timeline.push([simTime, timeline[timeline.length - 1][1]]);
    
    let area = 0; for (let i = 0; i < timeline.length - 1; i++) area += timeline[i][1] * (timeline[i + 1][0] - timeline[i][0]);
    const rho = lambda / (c * mu), stable = rho < 1, r = lambda / mu;
    let Lq_theory = NaN, Wq_theory = NaN;
      if (stable && lambda > 0 && mu > 0) {
      let sumTerm = 0; for (let k = 0; k < c; k++) sumTerm += Math.pow(r, k) / factorial(k);
      const P0 = 1 / (sumTerm + Math.pow(r, c) / (factorial(c) * (1 - rho)));
        Lq_theory = P0 * Math.pow(r, c) * rho / (factorial(c) * Math.pow(1 - rho, 2));
        Wq_theory = Lq_theory / lambda;
    }
    return { timeline, waitTimes, Lq_sim: area / simTime, Wq_sim: waitTimes.length > 0 ? waitTimes.reduce((a, b) => a + b, 0) / waitTimes.length : 0, rho, stable, Lq_theory, Wq_theory };
  }

    function bindSliders() {
    ["lambda", "mu", "servers", "time", "cost"].forEach(id => {
      const input = document.getElementById(id), valueEl = document.getElementById(`${id}-value`);
      input.addEventListener("input", () => valueEl.textContent = input.value);
    });
  }

    async function runSimulation() {
    const lambda = +document.getElementById("lambda").value, mu = +document.getElementById("mu").value;
    const servers = +document.getElementById("servers").value, simTime = +document.getElementById("time").value, cost = +document.getElementById("cost").value;
      const res = simulate(lambda, mu, servers, simTime);
    
      document.getElementById("rho-out").textContent = res.rho.toFixed(3);
    document.getElementById("stable-out").textContent = res.stable ? "Estable (œÅ < 1)" : "Inestable";
      document.getElementById("wq-out").textContent = res.Wq_sim.toFixed(3);
      document.getElementById("lq-out").textContent = res.Lq_sim.toFixed(3);
    document.getElementById("cost-out").textContent = "$" + (servers * cost).toLocaleString();

    Plotly.newPlot("queue-chart", [{ x: res.timeline.map(p => p[0]), y: res.timeline.map(p => p[1]), type: "scatter", mode: "lines", fill: "tozeroy", name: "Cola", line: { color: "#8ad6ff" } }], {
      title: `Evoluci√≥n de la cola ‚Äì M/M/${servers}`, xaxis: { title: "Tiempo (s)" }, yaxis: { title: "Longitud de cola" },
      paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0.1)', font: { color: '#94a3b8' }, margin: { t: 40, l: 50, r: 10, b: 40 }
    }, { responsive: true });
  }

    async function analyze() {
    const wrapper = document.getElementById("analysis-wrapper"), loading = document.getElementById("analysis-loading"), content = document.getElementById("analysis-content"), loadingBar = document.getElementById("loading-bar");
    wrapper.classList.add("visible"); loading.classList.add("active"); content.classList.remove("visible"); loadingBar.style.width = "0%";
    wrapper.scrollIntoView({ behavior: "smooth", block: "start" });
    await new Promise(r => setTimeout(r, 100));
    
    const lambda = +document.getElementById("lambda").value, mu = +document.getElementById("mu").value, serversCurrent = +document.getElementById("servers").value, costPerServer = +document.getElementById("cost").value;
    const simTime = Math.min(+document.getElementById("time").value, 400);
    const minServers = Math.max(1, Math.floor(lambda / mu) - 2), maxServers = serversCurrent + 15, results = [];
    
      for (let c = minServers; c <= maxServers; c++) {
        const res = simulate(lambda, mu, c, simTime);
      results.push({ servers: c, Wq: res.Wq_sim, Lq: res.Lq_sim, rho: res.rho, cost: c * costPerServer });
      loadingBar.style.width = ((c - minServers + 1) / (maxServers - minServers + 1)) * 100 + "%";
      await new Promise(r => setTimeout(r, 30));
    }
    
    loading.classList.remove("active"); content.classList.add("visible");
    
    Plotly.newPlot("scalability-chart", [
      { x: results.map(d => d.servers), y: results.map(d => d.Wq), type: "scatter", mode: "lines+markers", name: "Tiempo en cola (s)", line: { width: 3, color: "#8ad6ff" } },
      { x: results.map(d => d.servers), y: results.map(d => d.cost), type: "scatter", mode: "lines+markers", name: "Costo ($)", yaxis: "y2", line: { width: 3, color: "#72f0d5" } }
    ], { xaxis: { title: "Servidores (c)" }, yaxis: { title: "Tiempo en cola (s)" }, yaxis2: { title: "Costo ($)", overlaying: "y", side: "right" }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0.1)', font: { color: '#94a3b8' }, margin: { t: 20, l: 50, r: 50, b: 50 }, legend: { x: 0.5, y: 1.1, orientation: "h" } }, { responsive: true });
    
    Plotly.newPlot("tradeoff-chart", [{ x: results.map(d => d.cost), y: results.map(d => d.Wq), type: "scatter", mode: "lines+markers", name: "Frontera", line: { width: 4, color: "#8ad6ff" } }], { xaxis: { title: "Costo ($)" }, yaxis: { title: "Tiempo en cola (s)" }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0.1)', font: { color: '#94a3b8' }, margin: { t: 20, l: 50, r: 10, b: 50 } }, { responsive: true });
    
    document.getElementById("analysis-table").innerHTML = "<table><thead><tr><th>Servidores</th><th>Wq (s)</th><th>Lq</th><th>œÅ</th><th>Costo</th></tr></thead><tbody>" + results.map(r => `<tr><td>${r.servers}</td><td>${r.Wq.toFixed(3)}</td><td>${r.Lq.toFixed(3)}</td><td>${r.rho.toFixed(3)}</td><td>$${r.cost.toLocaleString()}</td></tr>`).join("") + "</tbody></table>";
    
    const candidates = results.filter(r => r.Wq < 0.5), optimum = candidates.length > 0 ? candidates.reduce((min, cur) => cur.cost < min.cost ? cur : min) : null;
    document.getElementById("analysis-optimum").innerHTML = optimum ? `Punto √≥ptimo: <strong>${optimum.servers} servidores</strong> ‚Üí Wq ‚âà ${optimum.Wq.toFixed(3)}s ‚Üí $${optimum.cost.toLocaleString()}` : "No se encontr√≥ configuraci√≥n con Wq < 0.5s";
  }

  window.addEventListener("load", () => {
      bindSliders();
      document.getElementById("run-sim").addEventListener("click", runSimulation);
      document.getElementById("analyze").addEventListener("click", analyze);
      runSimulation();
    
    // KaTeX
    function tryKaTeX() {
      if (typeof katex === "undefined") { setTimeout(tryKaTeX, 100); return; }
      var formulas = { 'f1': '\\rho = \\dfrac{\\lambda}{c \\cdot \\mu} < 1', 'f2': 'P_0 = \\left[ \\sum_{k=0}^{c-1} \\dfrac{r^k}{k!} + \\dfrac{r^c}{c!(1-\\rho)} \\right]^{-1}', 'f3': 'L_q = \\dfrac{P_0 \\cdot r^c \\cdot \\rho}{c! \\cdot (1-\\rho)^2}', 'f4': 'W_q = \\dfrac{L_q}{\\lambda}, W = W_q + \\dfrac{1}{\\mu}, L = \\lambda W' };
      Object.keys(formulas).forEach(id => { var el = document.getElementById(id); if (el) katex.render(formulas[id], el, { displayMode: false, throwOnError: false }); });
    }
    tryKaTeX();
  });
  </script>

  <style>
  /* Animaci√≥n M/M/c */
  .anim-section {
    margin-top: 40px;
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 28px;
    background: linear-gradient(135deg, rgba(138,214,255,0.03), rgba(114,240,213,0.02));
  }
  
  .anim-wrapper {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  
  .anim-params {
    text-align: center;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 15px;
      color: var(--muted);
    padding: 10px;
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
    border: 1px solid var(--border);
  }
  
  #mmc-canvas {
    display: block;
    width: 100%;
    max-width: 750px;
    margin: 0 auto;
    border-radius: 16px;
    border: 1px solid var(--border);
    transition: height 0.3s ease;
  }
  
  .anim-controls {
      display: flex;
      justify-content: space-between;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
  }
  
  .slider-group {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
  }
  
  .slider-group label {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(255,255,255,0.02);
      border: 1px solid var(--border);
    padding: 10px 16px;
    border-radius: 10px;
    font-size: 13px;
    color: var(--muted);
  }
  
  .slider-group input[type="range"] {
    width: 80px;
    accent-color: #8ad6ff;
  }
  
  .slider-val {
    font-weight: 700;
    color: #8ad6ff;
    font-family: 'JetBrains Mono', monospace;
    min-width: 35px;
    text-align: right;
  }
  
  .anim-btns {
    display: flex;
    gap: 10px;
  }
  
  .btn-start {
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    background: #58a6ff;
    color: #000;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
  }
  
  .btn-start:hover {
    background: #79b8ff;
    box-shadow: 0 4px 15px rgba(88,166,255,0.3);
  }
  
  .btn-start.active {
    background: #f0883e;
  }
  
  .btn-reset {
    padding: 10px 16px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: transparent;
      color: var(--muted);
    cursor: pointer;
    transition: all 0.2s;
      font-size: 14px;
  }
  
  .btn-reset:hover {
    border-color: #8ad6ff;
    color: #8ad6ff;
  }
  
  @media (max-width: 700px) {
    .anim-controls {
      flex-direction: column;
      align-items: stretch;
    }
    .slider-group {
      flex-direction: column;
    }
    .anim-btns {
      justify-content: center;
    }
  }

  .sim { margin-top: 40px; border: 1px solid var(--border); border-radius: 20px; padding: 20px; background: rgba(255,255,255,0.02); box-shadow: var(--shadow); }
  .sim-grid { display: grid; gap: 18px; }
  .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px; }
  label { display: grid; gap: 6px; font-size: 14px; color: var(--muted); background: rgba(255,255,255,0.02); border: 1px solid var(--border); padding: 12px; border-radius: 12px; }
  input[type="range"] { width: 100%; }
  .value { font-weight: 700; color: var(--ink); }
  .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
  .metric { padding: 14px; border: 1px solid var(--border); border-radius: 14px; background: rgba(255,255,255,0.02); text-align: left; }
  .metric h3 { margin: 6px 0 2px; font-size: 22px; color: var(--accent); }
  .metric p { color: var(--muted); font-size: 14px; }
  .actions { display: flex; gap: 12px; flex-wrap: wrap; }
  .formula { border: 1px solid var(--border); border-radius: 14px; padding: 20px; background: linear-gradient(135deg, rgba(138,214,255,0.03), rgba(114,240,213,0.02)); }
  .formula-list { display: flex; flex-direction: column; gap: 16px; margin-top: 16px; }
  .formula-item { display: flex; flex-direction: column; gap: 6px; padding: 14px 16px; background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 10px; }
  .formula-label { font-size: 12px; font-weight: 600; color: var(--accent); text-transform: uppercase; }
  .formula-math { font-size: 16px; color: var(--ink); }

  .analysis-wrapper { display: none; margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border); }
  .analysis-wrapper.visible { display: block; animation: slideDown 0.4s ease-out; }
  @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
  .analysis-loading { display: none; flex-direction: column; align-items: center; padding: 60px 20px; gap: 20px; }
  .analysis-loading.active { display: flex; }
  .loading-ring { display: inline-block; position: relative; width: 50px; height: 50px; }
  .loading-ring div { box-sizing: border-box; display: block; position: absolute; width: 40px; height: 40px; margin: 5px; border: 3px solid transparent; border-radius: 50%; animation: loading-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite; border-top-color: var(--accent); }
  .loading-ring div:nth-child(1) { animation-delay: -0.45s; } .loading-ring div:nth-child(2) { animation-delay: -0.3s; } .loading-ring div:nth-child(3) { animation-delay: -0.15s; }
  @keyframes loading-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .loading-progress { width: 200px; height: 4px; background: var(--border); border-radius: 4px; overflow: hidden; }
  .loading-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), #a78bfa); border-radius: 4px; transition: width 0.1s ease-out; }
  .analysis-content { display: none; } .analysis-content.visible { display: block; animation: fadeInUp 0.5s ease-out; }
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  .analysis-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
  .analysis-chart-box { background: linear-gradient(135deg, rgba(255,255,255,0.02), transparent); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
  .analysis-chart-box h4 { margin: 0 0 12px; font-size: 13px; font-weight: 600; color: var(--muted); text-transform: uppercase; }
  .analysis-chart-box > div { height: 350px; }
  .analysis-results { background: linear-gradient(135deg, rgba(255,255,255,0.02), transparent); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
  .analysis-results h4 { margin: 0 0 16px; font-size: 13px; font-weight: 600; color: var(--muted); text-transform: uppercase; }
  .analysis-table table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
  .analysis-table th, .analysis-table td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border); }
  .analysis-table th { background: rgba(138,214,255,0.08); color: var(--accent); font-weight: 600; font-size: 11px; text-transform: uppercase; }
  .analysis-table tbody tr:hover { background: rgba(255,255,255,0.02); }
  .analysis-optimum { margin-top: 16px; padding: 14px 18px; background: linear-gradient(90deg, rgba(34,211,238,0.1), rgba(167,139,250,0.05)); border-left: 3px solid var(--accent); border-radius: 0 8px 8px 0; font-size: 14px; }
  .analysis-optimum strong { color: var(--accent); }

  @media (max-width: 900px) { .analysis-charts { grid-template-columns: 1fr; } }
  </style>
