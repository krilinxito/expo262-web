---
import BaseLayout from '../../components/BaseLayout.astro';
import Topbar from '../../components/Topbar.astro';
import Hero from '../../components/Hero.astro';
import InformeCarousel from '../../components/InformeCarousel.astro';
import CodeSection from '../../components/CodeSection.astro';
import Footer from '../../components/Footer.astro';

const informeSlides = [
  { section: "Portada", title: "Modelos de Colas M/M/c en la Nube", subtitle: "Evaluaci√≥n de Rendimiento y Asignaci√≥n de Recursos", bullets: ["Grupo G42 ¬∑ Noviembre 2025", "Procesos Estoc√°sticos y Series de Tiempo", "Universidad Mayor de San Andr√©s"], image: "https://images.unsplash.com/photo-1544197150-b99a580bb7a8?w=800&q=80" },
  { section: "Resumen", title: "Resumen Ejecutivo", bullets: ["An√°lisis de simulaci√≥n de modelos de colas M/M/c aplicados a servicios cloud", "Evaluaci√≥n de rendimiento y asignaci√≥n √≥ptima de recursos", "Simulaci√≥n discreta en Python con interfaz web interactiva en Streamlit", "Comparaci√≥n de resultados te√≥ricos vs simulados con visualizaciones"], image: "https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=800&q=80" },
  { section: "Introducci√≥n", title: "Contexto del Problema", bullets: ["AWS, Azure y Google Cloud han transformado la gesti√≥n de infraestructuras", "Durante eventos como Black Friday, las peticiones aumentan exponencialmente", "Colas largas causan tiempos de respuesta lentos y abandono de carritos", "P√©rdidas econ√≥micas estimadas en miles de millones de d√≥lares anuales"], image: "https://images.unsplash.com/photo-1558494949-ef010cbdcc31?w=800&q=80" },
  { section: "Introducci√≥n", title: "Teor√≠a de Colas en Cloud", bullets: ["Modela sistemas donde entidades llegan aleatoriamente y son procesadas", "Aplicaciones: microservicios en Kubernetes, funciones serverless en AWS Lambda", "Mal dimensionamiento ‚Üí sobreprovisionamiento (costos) o subprovisionamiento (degradaci√≥n)", "M/M/c simula escenarios para evaluar trade-offs costo vs eficiencia"], image: "https://images.unsplash.com/photo-1667372393119-3d4c48d07fc9?w=800&q=80" },
  { section: "Problema", title: "Planteamiento del Problema", bullets: ["Incertidumbre: llegadas siguen patrones estoc√°sticos (horarios pico, campa√±as)", "Con c servidores (tasa Œº) y tasa llegada Œª: utilizaci√≥n œÅ = Œª/(cŒº) debe ser < 1", "Variaciones en Œª (100 a 500 req/s) requieren autoscaling din√°mico", "Escenarios reales: Netflix en estrenos, Uber Eats en horas pico"], image: "https://images.unsplash.com/photo-1573164713988-8665fc963095?w=800&q=80" },
  { section: "Problema", title: "Pregunta de Investigaci√≥n", highlight: true, bullets: ["¬øC√≥mo determinar el n√∫mero √≥ptimo de instancias virtuales (servidores)?", "Minimizar tiempo en cola Wq y longitud de cola Lq", "Controlar costo operativo simult√°neamente", "Considerando distribuciones Poisson para llegadas y Exponenciales para servicios"], image: "https://images.unsplash.com/photo-1516321318423-f06f85e504b3?w=800&q=80" },
  { section: "Objetivos", title: "Objetivo General", bullets: ["Evaluar el rendimiento y asignaci√≥n de recursos en sistemas M/M/c", "Aplicado a servicios en la nube", "Mediante simulaci√≥n discreta y modelado interactivo", "Con an√°lisis visual de resultados"], image: "https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=800&q=80" },
  { section: "Objetivos", title: "Objetivos Espec√≠ficos", bullets: ["Desarrollar simulador interactivo en Python con interfaz web Streamlit", "Analizar m√©tricas: Wq, Lq, œÅ y probabilidad de espera", "Identificar trade-offs costo-rendimiento mediante curvas de sensibilidad", "Comparar resultados simulados vs te√≥ricos para validar el modelo"], image: "https://images.unsplash.com/photo-1504868584819-f8e8b4b6d7e3?w=800&q=80" },
  { section: "Justificaci√≥n", title: "Justificaci√≥n Pr√°ctica", bullets: ["Gasto en cloud: $591 mil millones en 2023 (Gartner)", "Desperdicio estimado: 30-35% por ineficiencias en asignaci√≥n de recursos", "Modelos M/M/c permiten optimizar sin interrupciones en producci√≥n", "Mejora experiencia del usuario (SLA 99.9% uptime)"], image: "https://images.unsplash.com/photo-1553729459-efe14ef6055d?w=800&q=80" },
  { section: "Justificaci√≥n", title: "Justificaci√≥n Acad√©mica", bullets: ["Herramientas interactivas promueven aprendizaje activo", "Experimentaci√≥n con par√°metros reales de procesos estoc√°sticos", "Aplicaciones en fintech, healthcare donde colas impactan tiempos cr√≠ticos", "Prevenci√≥n de fallos costosos en sistemas de misi√≥n cr√≠tica"], image: "https://images.unsplash.com/photo-1523240795612-9a054b0db644?w=800&q=80" },
  { section: "Marco Te√≥rico", title: "Proceso de Poisson", bullets: ["Proceso de conteo {N(t), t ‚â• 0} donde N(t) = n√∫mero de eventos hasta t", "Propiedades: incrementos independientes, estacionarios, sin memoria", "Inter-llegada exponencial con par√°metro Œª", "Aplicaci√≥n: modela peticiones HTTP asumiendo independencia"], image: "https://images.unsplash.com/photo-1635070041078-e363dbe005cb?w=800&q=80" },
  { section: "Marco Te√≥rico", title: "Distribuci√≥n Exponencial", bullets: ['Tiempo entre eventos T ~ Exp(Œº), densidad f(t) = Œºe^{-Œºt}', 'Propiedad sin memoria: P(T > t+s | T > s) = P(T > t)', "En colas: representa tiempos de servicio variables pero predecibles", "Fundamental para modelar servicios en sistemas de colas"], image: "https://images.unsplash.com/photo-1509228468518-180dd4864904?w=800&q=80" },
  { section: "Marco Te√≥rico", title: "Cadenas de Markov", bullets: ['Estado S(t) = n√∫mero de peticiones en el sistema', 'Matriz de tasas Q: q_{n,n+1} = Œª, q_{n,n-1} = min(n,c)¬∑Œº', 'En equilibrio: œÄQ = 0 con Œ£œÄ·µ¢ = 1', "Base matem√°tica para el an√°lisis del modelo M/M/c"], image: "https://images.unsplash.com/photo-1527474305487-b87b222841cc?w=800&q=80" },
  { section: "Marco Te√≥rico", title: "Modelo M/M/c ¬∑ F√≥rmulas Principales", highlight: true, isFormula: true, bullets: ['œÅ = Œª/(cŒº) < 1 ‚Üí condici√≥n de estabilidad', 'P‚ÇÄ = [Œ£(r^k/k!) + r^c/(c!(1-œÅ))]‚Åª¬π, donde r = Œª/Œº', 'Lq = P‚ÇÄ¬∑r^c¬∑œÅ / (c!(1-œÅ)¬≤) ‚Üí longitud de cola', 'Wq = Lq/Œª ; W = Wq + 1/Œº ; L = ŒªW'], image: "https://images.unsplash.com/photo-1596495578065-6e0763fa1178?w=800&q=80" },
  { section: "Marco Te√≥rico", title: "Ejemplo Num√©rico", bullets: ['Par√°metros: Œª = 100, Œº = 20, c = 6 servidores', 'Utilizaci√≥n: œÅ = 100/(6√ó20) = 0.833 (sistema estable)', 'Longitud de cola: Lq ‚âà 2.5 peticiones esperando', "M√∫ltiples servidores mitigan significativamente las colas"], image: "https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=800&q=80" },
  { section: "Metodolog√≠a", title: "Dise√±o Metodol√≥gico", bullets: ["Tipo: Simulaci√≥n discreta de eventos + c√°lculos anal√≠ticos", "Python 3.12 con SimPy para simulaci√≥n de eventos", "Streamlit para interfaz web interactiva", "NumPy/Pandas para datos, Plotly para visualizaciones"], image: "https://images.unsplash.com/photo-1555949963-ff9fe0c870eb?w=800&q=80" },
  { section: "Metodolog√≠a", title: "Escenarios de Simulaci√≥n", bullets: ["Base: Œª=120, Œº=30, c=1..20, tiempo=600s, semilla fija", "Pico: Œª aumenta √ó3 para simular sobrecargas", "Sensibilidad: variar Œª (50-300), Œº (10-50), costos ($100-500/servidor)", "1000+ corridas por escenario para promedios estables"], image: "https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=800&q=80" },
  { section: "Metodolog√≠a", title: "Modelo de Simulaci√≥n", code: true, bullets: ["<code>env = Environment()</code> ‚Üí entorno SimPy", "<code>servidores = Resource(env, capacity=c)</code> ‚Üí pool de servidores", "<code>generar_llegadas(env, servidores, Œª)</code> ‚Üí proceso de llegadas Poisson", "<code>env.run(until=tiempo)</code> ‚Üí ejecutar simulaci√≥n"], image: "https://images.unsplash.com/photo-1542831371-29b0f74f9713?w=800&q=80" },
  { section: "Resultados", title: "Resultados Preliminares", bullets: ['c=4: œÅ=1.00 (inestable), Lq ‚Üí ‚àû, cola creciente', 'c=6: œÅ=0.67, Lq ‚âà 0.15, Wq ‚âà 0.001s ‚Üí estable', 'c=8: œÅ=0.50, Lq ‚âà 0.003, Wq ‚âà 0.00003s ‚Üí muy holgado', 'Punto √≥ptimo: c=7-8 donde Wq < 0.01s con costo razonable'], image: "https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=800&q=80" },
  { section: "Resultados", title: "An√°lisis de Sensibilidad", bullets: ['Para c < 5: sistema inestable (œÅ ‚â• 1), colas crecientes', "Simulaci√≥n aproxima bien la teor√≠a en sistemas estables", "Discrepancias m√≠nimas por varianza finita de la simulaci√≥n", 'En picos, aumentar c din√°micamente reduce Lq en 85%'], image: "https://images.unsplash.com/photo-1543286386-713bdd548da4?w=800&q=80" },
  { section: "Conclusiones", title: "Conclusiones", bullets: ["M/M/c es robusto para optimizar recursos cloud", 'Mantener œÅ < 0.8 para resiliencia ante picos', "Visualizaciones interactivas mejoran comprensi√≥n", 'Trade-off costo-rendimiento muestra diminishing returns m√°s all√° de cierto c'], image: "https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?w=800&q=80" },
  { section: "Aplicaciones", title: "Aplicaciones Pr√°cticas", bullets: ["AWS CloudWatch para autoscaling predictivo", "Laboratorios educativos de procesos estoc√°sticos", "E-commerce: modelar tr√°fico estacional (Black Friday)", "IoT: manejar colas de sensores en tiempo real"], image: "https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=800&q=80" },
  { section: "Futuro", title: "Extensiones Futuras", bullets: ["Colas finitas: modelo M/M/c/K", "Sistemas con prioridades (urgencia diferenciada)", "Integraci√≥n con m√©tricas reales de producci√≥n", "Machine Learning para predicci√≥n de Œª din√°mico"], image: "https://images.unsplash.com/photo-1485827404703-89b55fcc595e?w=800&q=80" },
  { section: "Bibliograf√≠a", title: "Referencias", bullets: ["Kleinrock, L. (1975). Queueing Systems: Volume 1 - Theory. Wiley.", "Gross, D. et al. (2008). Fundamentals of Queueing Theory. Wiley.", "Hillier, F. & Lieberman, G. (2010). Intro to Operations Research. McGraw-Hill.", "Gartner (2023). Cloud Computing Trends Report."], image: "https://images.unsplash.com/photo-1481627834876-b7833e8f5570?w=800&q=80" }
];

const codeFiles = [
  {
    filename: "simulator.py",
    description: "Motor de simulaci√≥n M/M/c con SimPy",
    code: `# simulator.py
import simpy
import random
import numpy as np
import math

def run_simulation(lambda_rate, mu_rate, num_servers, sim_time=600, seed=42):
    random.seed(seed)
    np.random.seed(seed)
    
    arrivals, queue_lengths, wait_times = [], [], []

    def arrival(env, servers):
        while True:
            yield env.timeout(random.expovariate(lambda_rate))
            arrivals.append(env.now)
            env.process(customer(env, servers))
    
    def customer(env, servers):
        arrive = env.now
        with servers.request() as req:
            queue_lengths.append(len(servers.queue))
            yield req
            wait_times.append(env.now - arrive)
            yield env.timeout(random.expovariate(mu_rate))
    
    env = simpy.Environment()
    servers = simpy.Resource(env, capacity=num_servers)
    env.process(arrival(env, servers))
    env.run(until=sim_time)

    # === C√ÅLCULO TE√ìRICO (Erlang-C) ===
    rho = lambda_rate / (num_servers * mu_rate)
    if rho < 1:
        r = lambda_rate / mu_rate
        sum_term = sum(r**k / math.factorial(k) for k in range(num_servers))
        P0 = 1 / (sum_term + r**num_servers / (math.factorial(num_servers) * (1-rho)))
        Lq = P0 * (r**num_servers) * rho / (math.factorial(num_servers) * (1-rho)**2)
        Wq = Lq / lambda_rate
    else:
        Lq = Wq = float('inf')

    return dict(rho=rho, Lq_theory=Lq, Wq_theory=Wq,
                Lq_sim=np.mean(queue_lengths), Wq_sim=np.mean(wait_times))`
  },
  {
    filename: "app.py",
    description: "Interfaz web con Streamlit y Plotly",
    code: `# app.py - Cloud Queue Simulator M/M/c
import streamlit as st
import numpy as np
import pandas as pd
import plotly.express as px
from simulator import run_simulation

st.set_page_config(page_title="Cloud Queue Simulator", layout="wide")

with st.sidebar:
    lambda_rate = st.slider("Tasa de llegada (Œª)", 10, 400, 120)
    mu_rate = st.slider("Tasa de servicio (Œº)", 10, 100, 30)
    num_servers = st.slider("Servidores (c)", 1, 40, 6)
    sim_time = st.slider("Duraci√≥n (s)", 120, 1800, 600)
    costo = st.number_input("Costo/servidor ($)", 10, 2000, 120)

results = run_simulation(lambda_rate, mu_rate, num_servers, sim_time)

# M√©tricas
c1, c2, c3, c4 = st.columns(4)
c1.metric("Utilizaci√≥n œÅ", f"{results['rho']:.1%}")
c2.metric("Tiempo en cola", f"{results['Wq_sim']:.3f} s")
c3.metric("Cola promedio", f"{results['Lq_sim']:.1f}")
c4.metric("Costo mensual", f"${num_servers * costo:,}")

# Gr√°fico de cola
df = pd.DataFrame(dict(
    Tiempo=np.linspace(0, sim_time, len(results.get('queue_lengths', []))),
    Cola=results.get('queue_lengths', [])
))
fig = px.area(df, x='Tiempo', y='Cola', template="plotly_dark")
st.plotly_chart(fig, use_container_width=True)`
  }
];
---

<BaseLayout 
  title="Proyecto 13 ¬∑ Modelos de colas en servicios en la nube (M/M/c)" 
  description="Evaluaci√≥n de rendimiento y asignaci√≥n de recursos con llegadas Poisson, servicios exponenciales y m√∫ltiples servidores."
  accentColor="#8ad6ff"
  accentColor2="#72f0d5"
>
  <Topbar 
    brandText="Proyecto 13 ¬∑ M/M/c"
    links={[
      { href: "/", text: "Home" },
      { href: "#informe", text: "Informe" },
      { href: "#sim", text: "Simulador" },
      { href: "#codigo", text: "C√≥digo Python" }
    ]}
  />

  <main>
    <Hero
      eyebrow="Tema 13"
      title="Modelos de colas en servicios en la nube (M/M/c)"
      description="Evaluaci√≥n de rendimiento y asignaci√≥n de recursos con llegadas Poisson, servicios exponenciales y m√∫ltiples servidores. Integra teor√≠a, simulaci√≥n y visualizaciones interactivas."
      tags={["Œª/Œº ¬∑ Erlang-C", "SimPy + Streamlit", "Cloud scaling"]}
      primaryBtn={{ href: "#sim", text: "Simulador M/M/c" }}
      secondaryBtn={{ href: "#informe", text: "Ver presentaci√≥n" }}
      panelStatus="Preparado"
      panelItems={[
        { label: "Asignatura", value: "Procesos Estoc√°sticos y Series de Tiempo" },
        { label: "Modelo", value: "M/M/c ¬∑ Poisson(Œª), Exp(Œº), c servidores" },
        { label: "Herramientas", value: "SimPy ¬∑ Streamlit ¬∑ Plotly ¬∑ NumPy/Pandas" }
      ]}
      panelFooterTags={["Grupo 42", "Colas ¬∑ Cloud"]}
    />

    <InformeCarousel slides={informeSlides} id="informe" />

    <!-- SIMULADOR M/M/c -->
    <section class="sim" id="sim">
      <div class="section__head">
        <div>
          <p class="eyebrow">Interactivo</p>
          <h2>Simulador M/M/c con JavaScript</h2>
          <p class="section__lede">Ajusta par√°metros, ejecuta la simulaci√≥n real en el navegador y analiza escalabilidad y costo.</p>
        </div>
      </div>

      <div class="sim-grid">
        <div class="controls">
          <label>Œª (llegadas/s)<input type="range" id="lambda" min="10" max="400" step="10" value="120" /><span class="value" id="lambda-value">120</span></label>
          <label>Œº (servicio por servidor)<input type="range" id="mu" min="5" max="120" step="5" value="30" /><span class="value" id="mu-value">30</span></label>
          <label>c (servidores)<input type="range" id="servers" min="1" max="40" step="1" value="6" /><span class="value" id="servers-value">6</span></label>
          <label>Tiempo de simulaci√≥n (s)<input type="range" id="time" min="100" max="2000" step="50" value="600" /><span class="value" id="time-value">600</span></label>
          <label>Costo/servidor (USD/mes)<input type="range" id="cost" min="50" max="1500" value="300" /><span class="value" id="cost-value">300</span></label>
        </div>

        <div class="metrics">
          <div class="metric"><p>Utilizaci√≥n œÅ</p><h3 id="rho-out">0.00</h3><small id="stable-out">‚Äî</small></div>
          <div class="metric"><p>Wq (s) ¬∑ Tiempo en cola</p><h3 id="wq-out">0.00</h3></div>
          <div class="metric"><p>Lq ¬∑ Cola promedio</p><h3 id="lq-out">0.00</h3></div>
          <div class="metric"><p>Costo mensual (USD)</p><h3 id="cost-out">0</h3></div>
        </div>

        <div class="actions">
          <button id="run-sim" class="primary">Ejecutar simulaci√≥n</button>
          <button id="analyze" class="ghost">Analizar escalabilidad</button>
        </div>

        <div class="charts"><div id="queue-chart" style="width:100%;height:400px;"></div></div>

        <div id="analysis-wrapper" class="analysis-wrapper">
          <div id="analysis-loading" class="analysis-loading">
            <div class="loading-ring"><div></div><div></div><div></div><div></div></div>
            <p>Simulando configuraciones...</p>
            <div class="loading-progress"><div id="loading-bar" class="loading-bar"></div></div>
          </div>
          <div id="analysis-content" class="analysis-content">
            <div class="analysis-charts">
              <div class="analysis-chart-box"><h4>Impacto del N√∫mero de Servidores</h4><div id="scalability-chart"></div></div>
              <div class="analysis-chart-box"><h4>Trade-off: Costo vs Rendimiento</h4><div id="tradeoff-chart"></div></div>
            </div>
            <div class="analysis-results">
              <h4>Resultados Detallados</h4>
              <div id="analysis-table" class="analysis-table"></div>
              <div id="analysis-optimum" class="analysis-optimum"></div>
            </div>
          </div>
        </div>

        <div class="formula">
          <p class="eyebrow">F√≥rmulas clave</p>
          <div class="formula-list">
            <div class="formula-item"><span class="formula-label">Utilizaci√≥n:</span><span class="formula-math" id="f1"></span></div>
            <div class="formula-item"><span class="formula-label">Probabilidad sistema vac√≠o:</span><span class="formula-math" id="f2"></span></div>
            <div class="formula-item"><span class="formula-label">Longitud de cola:</span><span class="formula-math" id="f3"></span></div>
            <div class="formula-item"><span class="formula-label">Tiempos y relaciones:</span><span class="formula-math" id="f4"></span></div>
          </div>
        </div>
      </div>
    </section>

    <CodeSection
      title="Simulador Python ¬∑ Streamlit + SimPy"
      subtitle="El simulador interactivo de arriba es una <strong>r√©plica en JavaScript</strong> del c√≥digo Python original. Aqu√≠ est√° el c√≥digo fuente completo para ejecutar la versi√≥n con Streamlit."
      notice={{ icon: "üí°", text: "<strong>Nota:</strong> El simulador M/M/c que ves arriba en esta p√°gina est√° implementado en JavaScript puro, replicando la l√≥gica del c√≥digo Python. Ambas versiones usan las mismas f√≥rmulas de Erlang-C y simulaci√≥n de eventos discretos." }}
      files={codeFiles}
      runCommands={`# Instalar dependencias
pip install streamlit simpy numpy pandas plotly

# Ejecutar la app
cd "proy 13 (python)"
streamlit run app.py`}
    />
  </main>

  <Footer rightText="Proyecto 13 ¬∑ Modelos de colas M/M/c" />
</BaseLayout>

<script is:inline>
  // === Simulador M/M/c en JavaScript ===
  function factorial(n) { let r = 1; for (let i = 2; i <= n; i++) r *= i; return r; }
  function randExp(rate) { return -Math.log(1 - Math.random()) / rate; }

  function simulate(lambda, mu, c, simTime) {
    let t = 0, nextArrival = randExp(lambda), serviceEndTimes = [], queue = [], waitTimes = [], timeline = [[0, 0]];
    while (true) {
      const nextService = serviceEndTimes.length > 0 ? serviceEndTimes[0] : Infinity;
      if (nextArrival <= nextService && nextArrival <= simTime) {
        t = nextArrival;
        if (serviceEndTimes.length < c) { serviceEndTimes.push(t + randExp(mu)); serviceEndTimes.sort((a, b) => a - b); waitTimes.push(0); }
        else { queue.push(t); }
        nextArrival += randExp(lambda);
        timeline.push([t, queue.length]);
      } else if (nextService < nextArrival && nextService <= simTime) {
        t = nextService; serviceEndTimes.shift();
        if (queue.length > 0) { waitTimes.push(t - queue.shift()); serviceEndTimes.push(t + randExp(mu)); serviceEndTimes.sort((a, b) => a - b); }
        timeline.push([t, queue.length]);
      } else { break; }
      if (t > simTime) break;
    }
    if (timeline[timeline.length - 1][0] < simTime) timeline.push([simTime, timeline[timeline.length - 1][1]]);
    
    let area = 0; for (let i = 0; i < timeline.length - 1; i++) area += timeline[i][1] * (timeline[i + 1][0] - timeline[i][0]);
    const rho = lambda / (c * mu), stable = rho < 1, r = lambda / mu;
    let Lq_theory = NaN, Wq_theory = NaN;
    if (stable && lambda > 0 && mu > 0) {
      let sumTerm = 0; for (let k = 0; k < c; k++) sumTerm += Math.pow(r, k) / factorial(k);
      const P0 = 1 / (sumTerm + Math.pow(r, c) / (factorial(c) * (1 - rho)));
      Lq_theory = P0 * Math.pow(r, c) * rho / (factorial(c) * Math.pow(1 - rho, 2));
      Wq_theory = Lq_theory / lambda;
    }
    return { timeline, waitTimes, Lq_sim: area / simTime, Wq_sim: waitTimes.length > 0 ? waitTimes.reduce((a, b) => a + b, 0) / waitTimes.length : 0, rho, stable, Lq_theory, Wq_theory };
  }

  function bindSliders() {
    ["lambda", "mu", "servers", "time", "cost"].forEach(id => {
      const input = document.getElementById(id), valueEl = document.getElementById(`${id}-value`);
      input.addEventListener("input", () => valueEl.textContent = input.value);
    });
  }

  async function runSimulation() {
    const lambda = +document.getElementById("lambda").value, mu = +document.getElementById("mu").value;
    const servers = +document.getElementById("servers").value, simTime = +document.getElementById("time").value, cost = +document.getElementById("cost").value;
    const res = simulate(lambda, mu, servers, simTime);
    
    document.getElementById("rho-out").textContent = res.rho.toFixed(3);
    document.getElementById("stable-out").textContent = res.stable ? "Estable (œÅ < 1)" : "Inestable";
    document.getElementById("wq-out").textContent = res.Wq_sim.toFixed(3);
    document.getElementById("lq-out").textContent = res.Lq_sim.toFixed(3);
    document.getElementById("cost-out").textContent = "$" + (servers * cost).toLocaleString();

    Plotly.newPlot("queue-chart", [{ x: res.timeline.map(p => p[0]), y: res.timeline.map(p => p[1]), type: "scatter", mode: "lines", fill: "tozeroy", name: "Cola", line: { color: "#8ad6ff" } }], {
      title: `Evoluci√≥n de la cola ‚Äì M/M/${servers}`, xaxis: { title: "Tiempo (s)" }, yaxis: { title: "Longitud de cola" },
      paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0.1)', font: { color: '#94a3b8' }, margin: { t: 40, l: 50, r: 10, b: 40 }
    }, { responsive: true });
  }

  async function analyze() {
    const wrapper = document.getElementById("analysis-wrapper"), loading = document.getElementById("analysis-loading"), content = document.getElementById("analysis-content"), loadingBar = document.getElementById("loading-bar");
    wrapper.classList.add("visible"); loading.classList.add("active"); content.classList.remove("visible"); loadingBar.style.width = "0%";
    wrapper.scrollIntoView({ behavior: "smooth", block: "start" });
    await new Promise(r => setTimeout(r, 100));
    
    const lambda = +document.getElementById("lambda").value, mu = +document.getElementById("mu").value, serversCurrent = +document.getElementById("servers").value, costPerServer = +document.getElementById("cost").value;
    const simTime = Math.min(+document.getElementById("time").value, 400);
    const minServers = Math.max(1, Math.floor(lambda / mu) - 2), maxServers = serversCurrent + 15, results = [];
    
    for (let c = minServers; c <= maxServers; c++) {
      const res = simulate(lambda, mu, c, simTime);
      results.push({ servers: c, Wq: res.Wq_sim, Lq: res.Lq_sim, rho: res.rho, cost: c * costPerServer });
      loadingBar.style.width = ((c - minServers + 1) / (maxServers - minServers + 1)) * 100 + "%";
      await new Promise(r => setTimeout(r, 30));
    }
    
    loading.classList.remove("active"); content.classList.add("visible");
    
    Plotly.newPlot("scalability-chart", [
      { x: results.map(d => d.servers), y: results.map(d => d.Wq), type: "scatter", mode: "lines+markers", name: "Tiempo en cola (s)", line: { width: 3, color: "#8ad6ff" } },
      { x: results.map(d => d.servers), y: results.map(d => d.cost), type: "scatter", mode: "lines+markers", name: "Costo ($)", yaxis: "y2", line: { width: 3, color: "#72f0d5" } }
    ], { xaxis: { title: "Servidores (c)" }, yaxis: { title: "Tiempo en cola (s)" }, yaxis2: { title: "Costo ($)", overlaying: "y", side: "right" }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0.1)', font: { color: '#94a3b8' }, margin: { t: 20, l: 50, r: 50, b: 50 }, legend: { x: 0.5, y: 1.1, orientation: "h" } }, { responsive: true });
    
    Plotly.newPlot("tradeoff-chart", [{ x: results.map(d => d.cost), y: results.map(d => d.Wq), type: "scatter", mode: "lines+markers", name: "Frontera", line: { width: 4, color: "#8ad6ff" } }], { xaxis: { title: "Costo ($)" }, yaxis: { title: "Tiempo en cola (s)" }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0.1)', font: { color: '#94a3b8' }, margin: { t: 20, l: 50, r: 10, b: 50 } }, { responsive: true });
    
    document.getElementById("analysis-table").innerHTML = "<table><thead><tr><th>Servidores</th><th>Wq (s)</th><th>Lq</th><th>œÅ</th><th>Costo</th></tr></thead><tbody>" + results.map(r => `<tr><td>${r.servers}</td><td>${r.Wq.toFixed(3)}</td><td>${r.Lq.toFixed(3)}</td><td>${r.rho.toFixed(3)}</td><td>$${r.cost.toLocaleString()}</td></tr>`).join("") + "</tbody></table>";
    
    const candidates = results.filter(r => r.Wq < 0.5), optimum = candidates.length > 0 ? candidates.reduce((min, cur) => cur.cost < min.cost ? cur : min) : null;
    document.getElementById("analysis-optimum").innerHTML = optimum ? `Punto √≥ptimo: <strong>${optimum.servers} servidores</strong> ‚Üí Wq ‚âà ${optimum.Wq.toFixed(3)}s ‚Üí $${optimum.cost.toLocaleString()}` : "No se encontr√≥ configuraci√≥n con Wq < 0.5s";
  }

  window.addEventListener("load", () => {
    bindSliders();
    document.getElementById("run-sim").addEventListener("click", runSimulation);
    document.getElementById("analyze").addEventListener("click", analyze);
    runSimulation();
    
    // KaTeX
    function tryKaTeX() {
      if (typeof katex === "undefined") { setTimeout(tryKaTeX, 100); return; }
      var formulas = { 'f1': '\\rho = \\dfrac{\\lambda}{c \\cdot \\mu} < 1', 'f2': 'P_0 = \\left[ \\sum_{k=0}^{c-1} \\dfrac{r^k}{k!} + \\dfrac{r^c}{c!(1-\\rho)} \\right]^{-1}', 'f3': 'L_q = \\dfrac{P_0 \\cdot r^c \\cdot \\rho}{c! \\cdot (1-\\rho)^2}', 'f4': 'W_q = \\dfrac{L_q}{\\lambda}, W = W_q + \\dfrac{1}{\\mu}, L = \\lambda W' };
      Object.keys(formulas).forEach(id => { var el = document.getElementById(id); if (el) katex.render(formulas[id], el, { displayMode: false, throwOnError: false }); });
    }
    tryKaTeX();
  });
</script>

<style>
  .sim { margin-top: 40px; border: 1px solid var(--border); border-radius: 20px; padding: 20px; background: rgba(255,255,255,0.02); box-shadow: var(--shadow); }
  .sim-grid { display: grid; gap: 18px; }
  .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px; }
  label { display: grid; gap: 6px; font-size: 14px; color: var(--muted); background: rgba(255,255,255,0.02); border: 1px solid var(--border); padding: 12px; border-radius: 12px; }
  input[type="range"] { width: 100%; }
  .value { font-weight: 700; color: var(--ink); }
  .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
  .metric { padding: 14px; border: 1px solid var(--border); border-radius: 14px; background: rgba(255,255,255,0.02); text-align: left; }
  .metric h3 { margin: 6px 0 2px; font-size: 22px; color: var(--accent); }
  .metric p { color: var(--muted); font-size: 14px; }
  .actions { display: flex; gap: 12px; flex-wrap: wrap; }
  .formula { border: 1px solid var(--border); border-radius: 14px; padding: 20px; background: linear-gradient(135deg, rgba(138,214,255,0.03), rgba(114,240,213,0.02)); }
  .formula-list { display: flex; flex-direction: column; gap: 16px; margin-top: 16px; }
  .formula-item { display: flex; flex-direction: column; gap: 6px; padding: 14px 16px; background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 10px; }
  .formula-label { font-size: 12px; font-weight: 600; color: var(--accent); text-transform: uppercase; }
  .formula-math { font-size: 16px; color: var(--ink); }

  .analysis-wrapper { display: none; margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border); }
  .analysis-wrapper.visible { display: block; animation: slideDown 0.4s ease-out; }
  @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
  .analysis-loading { display: none; flex-direction: column; align-items: center; padding: 60px 20px; gap: 20px; }
  .analysis-loading.active { display: flex; }
  .loading-ring { display: inline-block; position: relative; width: 50px; height: 50px; }
  .loading-ring div { box-sizing: border-box; display: block; position: absolute; width: 40px; height: 40px; margin: 5px; border: 3px solid transparent; border-radius: 50%; animation: loading-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite; border-top-color: var(--accent); }
  .loading-ring div:nth-child(1) { animation-delay: -0.45s; } .loading-ring div:nth-child(2) { animation-delay: -0.3s; } .loading-ring div:nth-child(3) { animation-delay: -0.15s; }
  @keyframes loading-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .loading-progress { width: 200px; height: 4px; background: var(--border); border-radius: 4px; overflow: hidden; }
  .loading-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), #a78bfa); border-radius: 4px; transition: width 0.1s ease-out; }
  .analysis-content { display: none; } .analysis-content.visible { display: block; animation: fadeInUp 0.5s ease-out; }
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  .analysis-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
  .analysis-chart-box { background: linear-gradient(135deg, rgba(255,255,255,0.02), transparent); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
  .analysis-chart-box h4 { margin: 0 0 12px; font-size: 13px; font-weight: 600; color: var(--muted); text-transform: uppercase; }
  .analysis-chart-box > div { height: 350px; }
  .analysis-results { background: linear-gradient(135deg, rgba(255,255,255,0.02), transparent); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
  .analysis-results h4 { margin: 0 0 16px; font-size: 13px; font-weight: 600; color: var(--muted); text-transform: uppercase; }
  .analysis-table table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
  .analysis-table th, .analysis-table td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border); }
  .analysis-table th { background: rgba(138,214,255,0.08); color: var(--accent); font-weight: 600; font-size: 11px; text-transform: uppercase; }
  .analysis-table tbody tr:hover { background: rgba(255,255,255,0.02); }
  .analysis-optimum { margin-top: 16px; padding: 14px 18px; background: linear-gradient(90deg, rgba(34,211,238,0.1), rgba(167,139,250,0.05)); border-left: 3px solid var(--accent); border-radius: 0 8px 8px 0; font-size: 14px; }
  .analysis-optimum strong { color: var(--accent); }

  @media (max-width: 900px) { .analysis-charts { grid-template-columns: 1fr; } }
</style>
