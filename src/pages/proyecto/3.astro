---
import BaseLayout from '../../components/BaseLayout.astro';
import Topbar from '../../components/Topbar.astro';
import Hero from '../../components/Hero.astro';
import InformeCarousel from '../../components/InformeCarousel.astro';
import CodeSection from '../../components/CodeSection.astro';
import Footer from '../../components/Footer.astro';

// Datos del informe
const informeSlides = [
  { section: "Portada", title: "Sistema de Colas M/M/1 en Servidor Flask", subtitle: "Modelado y Simulaci√≥n de Tr√°fico Web", bullets: ["Grupo G42 ¬∑ Noviembre 2025", "Procesos Estoc√°sticos y Series de Tiempo", "Universidad Mayor de San Andr√©s"], image: "https://itflowcy.com/wp-content/uploads/2024/02/What-is-Networking.jpg" },
  { section: "Introducci√≥n", title: "Contexto y Motivaci√≥n", bullets: ["Los servidores web reciben solicitudes que llegan aleatoriamente", "El modelo M/M/1 permite predecir rendimiento y cuellos de botella", "Captura de datos reales con Wireshark para estimar Œª y Œº", "Validaci√≥n mediante simulaci√≥n discreta con SimPy"], image: "https://media.geeksforgeeks.org/wp-content/uploads/20190927155217/webserver.png" },
  { section: "Problema", title: "Planteamiento del Problema", highlight: true, bullets: ["¬øEl tr√°fico HTTP sigue un proceso de Poisson?", "¬øLos tiempos de servicio son exponenciales?", "¬øEl servidor Flask se comporta como un sistema M/M/1?", "¬øLas m√©tricas observadas coinciden con la teor√≠a?"], image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcROdhT8umDzN4T6pN2X6IaCA7st9RUmfBALJQ&s" },
  { section: "Marco Te√≥rico", title: "Modelo M/M/1", highlight: true, isFormula: true, bullets: ["Primera M: llegadas Poisson con tasa Œª", "Segunda M: tiempos de servicio Exp(Œº)", "El 1: un solo servidor con disciplina FIFO", "Condici√≥n de estabilidad: œÅ = Œª/Œº < 1"], image: "https://i.sstatic.net/MnlXk.jpg" },
  { section: "Marco Te√≥rico", title: "F√≥rmulas M/M/1", isFormula: true, bullets: ["Utilizaci√≥n: œÅ = Œª/Œº", "Clientes en sistema: L = œÅ/(1-œÅ) ; Clientes en cola: Lq = œÅ¬≤/(1-œÅ)", "Tiempo en sistema: W = 1/(Œº-Œª)", "Tiempo en cola: Wq = Œª/(Œº(Œº-Œª))"], image: "https://real-statistics.com/wp-content/uploads/2023/02/mm1-wait-time.png" },
  { section: "Metodolog√≠a", title: "Dise√±o del Experimento", bullets: ["Servidor Flask monohilo en puerto 5001 con lock (capacidad=1)", "Cliente genera 50 solicitudes con interarrivals ~ Exp(Œª=0.5)", "Wireshark captura tr√°fico HTTP ‚Üí timestamps a CSV", "SimPy para simulaci√≥n discreta de eventos"], image: "https://miro.medium.com/v2/resize:fit:1400/1*sQ9FI1LOgPMm7YJhvXPelg.png" },
  { section: "Resultados", title: "Par√°metros Estimados", highlight: true, bullets: ["Œª emp√≠rico = 0.3057 sol/s ; Œº emp√≠rico = 0.8185 sol/s", "Utilizaci√≥n œÅ = Œª/Œº = 0.3734 (sistema estable)", "El servidor est√° ocupado solo el 37% del tiempo", "Sistema muy holgado para la carga aplicada"], image: "https://media.tenor.com/l-PbZelgds0AAAAM/favorite-facts.gif" },
  { section: "Resultados", title: "Comparaci√≥n Teor√≠a vs Simulaci√≥n", bullets: ["Wq te√≥rico = 0.73s ‚Üí Wq simulado ‚âà 1.20s (+65%)", "W te√≥rico = 1.95s ‚Üí W simulado ‚âà 2.39s (+22%)", "Diferencias por varianza Monte Carlo y factores reales", "Latencia TCP/IP, planificaci√≥n CPU, buffers del SO"], image: "https://cdn.sanity.io/images/oq9f4n1v/production/070ab2e6d15256fd528205374f7c49948deaf5f5-1201x628.png?fm=png" },
  { section: "Conclusiones", title: "Conclusiones", bullets: ["El servidor Flask se comporta como un sistema M/M/1", "Utilizaci√≥n œÅ = 0.37 garantiza estabilidad y buen rendimiento", "M√©tricas simuladas aproximan razonablemente a las te√≥ricas", "La integraci√≥n Flask + Wireshark + SimPy valid√≥ el modelo"], image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT2Z0r-zn1q6eHdY0CZoluECosQFgUccvYu6g&s" }
];

// Archivos de c√≥digo
const codeFiles = [
  {
    filename: "server.py",
    description: "Servidor Flask con cola M/M/1",
    code: "# server.py - Servidor Flask M/M/1\nfrom flask import Flask\nimport time, random, csv, threading, os\n\nMU = 0.82  # tasa de servicio (clientes/segundo)\napp = Flask(__name__)\nlock = threading.Lock()  # Capacidad = 1\n\n@app.route(\"/\")\ndef atender_cliente():\n    llegada = time.time()\n    \n    with lock:  # Solo un cliente a la vez\n        inicio_servicio = time.time()\n        tiempo_servicio = random.expovariate(MU)\n        time.sleep(tiempo_servicio)\n        salida = time.time()\n    \n    tiempo_en_sistema = salida - llegada\n    tiempo_espera = inicio_servicio - llegada\n    \n    return f\"Servicio={tiempo_servicio}s, Espera={tiempo_espera}s\"\n\nif __name__ == \"__main__\":\n    random.seed(123)\n    app.run(host=\"127.0.0.1\", port=5001, threaded=True)"
  },
  {
    filename: "client.py",
    description: "Generador de llegadas Poisson",
    code: "# client.py - Generador de llegadas Poisson\nimport requests, random, time, csv\n\nURL = \"http://127.0.0.1:5001/\"\nLAMBDA = 0.5  # tasa de llegadas (clientes/segundo)\nN_SOLICITUDES = 50\n\nrandom.seed(123)\ninterarrivals = []\n\nfor i in range(1, N_SOLICITUDES + 1):\n    interarrival = random.expovariate(LAMBDA)\n    interarrivals.append(interarrival)\n    time.sleep(interarrival)\n    \n    t_inicio = time.time()\n    r = requests.get(URL, timeout=10)\n    t_total = time.time() - t_inicio\n    print(f\"[Req {i}] Status={r.status_code}, Total={t_total}s\")\n\n# lambda empirico\nlambda_emp = 1.0 / (sum(interarrivals) / len(interarrivals))\nprint(f\"lambda teorico={LAMBDA}, lambda empirico={lambda_emp}\")"
  },
  {
    filename: "sim.py",
    description: "Simulaci√≥n discreta con SimPy",
    code: "# sim.py - Simulacion M/M/1 con SimPy\nimport simpy, random, numpy as np\n\nLAMBDA = 0.3057  # tasa de llegadas\nMU = 0.8185      # tasa de servicio\nSIM_TIME = 2000.0\n\ntiempos_espera, tiempos_sistema = [], []\n\ndef cliente(env, servidor):\n    llegada = env.now\n    with servidor.request() as req:\n        yield req\n        espera = env.now - llegada\n        tiempos_espera.append(espera)\n        \n        tiempo_servicio = random.expovariate(MU)\n        yield env.timeout(tiempo_servicio)\n        tiempos_sistema.append(env.now - llegada)\n\ndef generador(env, servidor):\n    while True:\n        yield env.timeout(random.expovariate(LAMBDA))\n        env.process(cliente(env, servidor))\n\nenv = simpy.Environment()\nservidor = simpy.Resource(env, capacity=1)\nenv.process(generador(env, servidor))\nenv.run(until=SIM_TIME)\n\nprint(f\"Wq simulado = {np.mean(tiempos_espera)} s\")\nprint(f\"W simulado  = {np.mean(tiempos_sistema)} s\")"
  }
];

const runCommands = `# Terminal 1: Iniciar servidor
cd "Proy 3/code"
python server.py

# Terminal 2: Ejecutar cliente (mientras Wireshark captura)
python client.py --lmbda 0.5 --n 50

# Terminal 3: Simulaci√≥n SimPy
python sim.py`;
---

<BaseLayout 
  title="Proyecto 3 ¬∑ Sistema de Colas M/M/1 en Servidor Flask" 
  description="Modelado y simulaci√≥n de tr√°fico web usando teor√≠a de colas M/M/1 con Flask, Wireshark y SimPy."
  accentColor="#10b981"
  accentColor2="#3b82f6"
>
  <Topbar 
    brandText="Proyecto 3 ¬∑ M/M/1"
    links={[
      { href: "/", text: "Home" },
      { href: "#informe", text: "Informe" },
      { href: "#animacion", text: "Animaci√≥n" },
      { href: "#sim", text: "Simulador" },
      { href: "#codigo", text: "C√≥digo" }
    ]}
  />

  <main>
    <Hero
      eyebrow="Tema 3"
      title="Redes de computadoras: modelado de tr√°fico y solicitudes"
      description="Modelado del flujo de paquetes y solicitudes HTTP usando <strong>teor√≠a de colas M/M/1</strong>. Captura de datos reales con Wireshark, servidor Flask y simulaci√≥n con SimPy."
      tags={["Poisson ¬∑ Exp(Œº)", "Flask + Wireshark", "SimPy", "œÅ = 0.37"]}
      primaryBtn={{ href: "#sim", text: "Simulador M/M/1" }}
      secondaryBtn={{ href: "#informe", text: "Ver presentaci√≥n" }}
      panelStatus="Completado"
      panelItems={[
        { label: "Modelo", value: "M/M/1 ¬∑ Poisson(Œª) ¬∑ Exp(Œº) ¬∑ 1 servidor" },
        { label: "Par√°metros", value: "Œª = 0.3057 /s ¬∑ Œº = 0.8185 /s" },
        { label: "Utilizaci√≥n", value: "œÅ = 0.3734 (estable)", accent: true }
      ]}
      panelFooterTags={["Grupo 42", "Flask ¬∑ SimPy"]}
    />

    <InformeCarousel slides={informeSlides} id="informe" />

    <!-- ANIMACI√ìN VISUAL M/M/1 (estilo Manim) -->
    <section class="anim-section" id="animacion">
      <div class="section__head">
        <div>
          <p class="eyebrow">Visualizaci√≥n Interactiva</p>
          <h2>Modelo M/M/1</h2>
          <p class="section__lede">Observa c√≥mo los clientes llegan, esperan en cola y son atendidos.</p>
        </div>
      </div>

      <div class="anim-wrapper">
        <div class="anim-params">
          <span id="anim-params-text">Œª = 0.80, Œº = 1.20, œÅ = 0.67</span>
        </div>
        
        <canvas id="mm1-canvas" width="700" height="400"></canvas>
        
        <div class="anim-controls">
          <div class="slider-group">
            <label>
              <span>Œª (llegadas/s)</span>
              <input type="range" id="anim-lambda" min="0.3" max="2.5" step="0.1" value="0.8" />
              <span class="slider-val" id="anim-lambda-val">0.80</span>
            </label>
            <label>
              <span>Œº (servicio/s)</span>
              <input type="range" id="anim-mu" min="0.5" max="3" step="0.1" value="1.2" />
              <span class="slider-val" id="anim-mu-val">1.20</span>
            </label>
          </div>
          <div class="anim-btns">
            <button id="anim-start" class="btn-start">‚ñ∂ Iniciar</button>
            <button id="anim-reset" class="btn-reset">‚Ü∫ Reset</button>
          </div>
        </div>
      </div>
    </section>

    <!-- SIMULADOR M/M/1 -->
    <section class="sim" id="sim">
      <div class="section__head">
        <div>
          <p class="eyebrow">Interactivo</p>
          <h2>Simulador de Colas M/M/1</h2>
          <p class="section__lede">Ajusta los par√°metros Œª y Œº para ver c√≥mo afectan al sistema.</p>
        </div>
      </div>

      <div class="sim-grid">
        <div class="controls">
          <label>
            Œª (llegadas/s)
            <input type="range" id="lambda" min="0.1" max="2" step="0.05" value="0.3" />
            <span class="value" id="lambda-value">0.30</span>
          </label>
          <label>
            Œº (servicio/s)
            <input type="range" id="mu" min="0.2" max="3" step="0.05" value="0.8" />
            <span class="value" id="mu-value">0.80</span>
          </label>
          <label>
            Tiempo de simulaci√≥n (s)
            <input type="range" id="time" min="100" max="2000" step="50" value="500" />
            <span class="value" id="time-value">500</span>
          </label>
        </div>

        <div class="metrics">
          <div class="metric"><p>Utilizaci√≥n œÅ</p><h3 id="rho-out">0.00</h3><small id="stable-out">‚Äî</small></div>
          <div class="metric"><p>L ¬∑ Clientes en sistema</p><h3 id="l-out">0.00</h3></div>
          <div class="metric"><p>Lq ¬∑ Clientes en cola</p><h3 id="lq-out">0.00</h3></div>
          <div class="metric"><p>W (s) ¬∑ Tiempo en sistema</p><h3 id="w-out">0.00</h3></div>
          <div class="metric"><p>Wq (s) ¬∑ Tiempo en cola</p><h3 id="wq-out">0.00</h3></div>
        </div>

        <div class="actions">
          <button id="run-sim" class="primary">Ejecutar simulaci√≥n</button>
        </div>

        <div class="charts">
          <div id="queue-chart" style="width:100%;height:350px;"></div>
        </div>

        <div class="charts-row">
          <div class="chart-half">
            <h4>Distribuci√≥n de Tiempos en Cola</h4>
            <div id="wait-hist" style="width:100%;height:280px;"></div>
          </div>
          <div class="chart-half">
            <h4>Clientes en Sistema vs Tiempo</h4>
            <div id="clients-chart" style="width:100%;height:280px;"></div>
          </div>
        </div>

        <div class="formula-section">
          <p class="eyebrow">F√≥rmulas M/M/1</p>
          <div class="formula-grid">
            <div class="formula-item"><span class="formula-label">Utilizaci√≥n:</span><span class="formula-math" id="f-rho"></span></div>
            <div class="formula-item"><span class="formula-label">Clientes en sistema:</span><span class="formula-math" id="f-l"></span></div>
            <div class="formula-item"><span class="formula-label">Clientes en cola:</span><span class="formula-math" id="f-lq"></span></div>
            <div class="formula-item"><span class="formula-label">Tiempo en sistema:</span><span class="formula-math" id="f-w"></span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- RESULTADOS EMP√çRICOS -->
    <section class="results" id="resultados">
      <div class="section__head">
        <div>
          <p class="eyebrow">Datos Reales</p>
          <h2>Resultados del Experimento</h2>
          <p class="section__lede">M√©tricas obtenidas con Flask + Wireshark.</p>
        </div>
      </div>

      <div class="results-grid">
        <div class="result-card highlight">
          <h4>Par√°metros Estimados</h4>
          <div class="param-row">
            <div class="param"><span class="param-label">Œª emp√≠rico</span><span class="param-value">0.3057</span><span class="param-unit">solicitudes/s</span></div>
            <div class="param"><span class="param-label">Œº emp√≠rico</span><span class="param-value">0.8185</span><span class="param-unit">servicios/s</span></div>
            <div class="param accent"><span class="param-label">œÅ = Œª/Œº</span><span class="param-value">0.3734</span><span class="param-unit">utilizaci√≥n</span></div>
          </div>
        </div>

        <div class="result-card">
          <h4>M√©tricas Te√≥ricas M/M/1</h4>
          <table class="data-table">
            <tr><td>L (clientes en sistema)</td><td class="val">0.5960</td></tr>
            <tr><td>Lq (clientes en cola)</td><td class="val">0.2226</td></tr>
            <tr><td>W (tiempo en sistema)</td><td class="val">1.9499 s</td></tr>
            <tr><td>Wq (tiempo en cola)</td><td class="val">0.7281 s</td></tr>
          </table>
        </div>

        <div class="result-card comparison">
          <h4>Teor√≠a vs Simulaci√≥n</h4>
          <table class="data-table">
            <thead><tr><th>M√©trica</th><th>Te√≥rico</th><th>Simulado</th><th>Œî%</th></tr></thead>
            <tbody>
              <tr><td>Wq (s)</td><td>0.7283</td><td>1.2029</td><td class="warn">+65%</td></tr>
              <tr><td>W (s)</td><td>1.9501</td><td>2.3944</td><td class="warn">+22%</td></tr>
            </tbody>
          </table>
          <p class="note">Diferencias por varianza Monte Carlo y latencias TCP/IP reales.</p>
        </div>

        <div class="result-card wide">
          <h4>Distribuciones Observadas</h4>
          <div id="dist-charts" style="width:100%;height:280px;"></div>
        </div>
      </div>
    </section>

    <CodeSection
      title="Implementaci√≥n Python"
      subtitle="Servidor Flask, cliente generador y simulaci√≥n SimPy."
      notice={{ icon: "üñ•Ô∏è", text: "<strong>Arquitectura:</strong> El servidor Flask usa <code>threading.Lock()</code> para garantizar capacidad = 1 (M/M/1). El cliente genera llegadas Poisson y Wireshark captura el tr√°fico para an√°lisis offline." }}
      files={codeFiles}
      runCommands={runCommands}
    />
  </main>

  <Footer rightText="Proyecto 3 ¬∑ Colas M/M/1 en Flask" />
</BaseLayout>

<script is:inline>
// Animaci√≥n M/M/1 estilo Manim
(function() {
  const canvas = document.getElementById('mm1-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  
  let lambda = 0.8, mu = 1.2;
  let running = false;
  let balls = []; // { state: 'arriving'|'queue'|'toServer'|'serving'|'exiting', x, y, targetX, targetY, queueIndex, serviceProgress, serviceDuration }
  let served = 0;
  let nextArrival = 0;
  let simTime = 0;
  let serverBusy = false;
  
  // Layout
  const L = {
    queueX: 180,
    queueTopY: 100,
    queueSpacing: 45,
    serverX: 480,
    serverY: 200,
    serverW: 90,
    serverH: 90,
    exitX: 650,
    ballR: 18,
    arriveFromX: -50,
    arriveY: 100
  };
  
  const colors = {
    bg: '#0d1117',
    grid: 'rgba(255,255,255,0.03)',
    text: '#8b949e',
    textBright: '#c9d1d9',
    ball: '#58a6ff',
    serving: '#f0883e',
    server: '#238636',
    serverFill: 'rgba(35,134,54,0.15)',
    exit: '#a371f7'
  };
  
  function randExp(rate) {
    return -Math.log(1 - Math.random()) / rate;
  }
  
  function lerp(a, b, t) {
    return a + (b - a) * Math.min(1, t);
  }
  
  function drawScene() {
    // Fondo
    ctx.fillStyle = colors.bg;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Grid sutil
    ctx.strokeStyle = colors.grid;
    ctx.lineWidth = 1;
    for (let x = 0; x < canvas.width; x += 40) {
      ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
    }
    for (let y = 0; y < canvas.height; y += 40) {
      ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
    }
    
    // L√≠nea de cola (vertical)
    ctx.strokeStyle = 'rgba(88,166,255,0.3)';
    ctx.lineWidth = 2;
    ctx.setLineDash([6, 4]);
    ctx.beginPath();
    ctx.moveTo(L.queueX, L.queueTopY - 30);
    ctx.lineTo(L.queueX, L.queueTopY + 8 * L.queueSpacing);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Etiqueta cola
    ctx.fillStyle = colors.text;
    ctx.font = '12px Manrope, system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('COLA', L.queueX, L.queueTopY - 45);
    
    // Servidor (cuadrado)
    ctx.strokeStyle = colors.server;
    ctx.lineWidth = 3;
    ctx.strokeRect(L.serverX - L.serverW/2, L.serverY - L.serverH/2, L.serverW, L.serverH);
    ctx.fillStyle = colors.serverFill;
    ctx.fillRect(L.serverX - L.serverW/2, L.serverY - L.serverH/2, L.serverW, L.serverH);
    
    // Etiqueta servidor
    ctx.fillStyle = colors.text;
    ctx.textAlign = 'center';
    ctx.fillText('SERVIDOR', L.serverX, L.serverY + L.serverH/2 + 25);
    
    // Estado del servidor
    ctx.font = 'bold 14px Manrope, system-ui, sans-serif';
    ctx.fillStyle = serverBusy ? colors.serving : colors.server;
    ctx.fillText(serverBusy ? 'Ocupado' : 'Libre', L.serverX, L.serverY - L.serverH/2 - 15);
    
    // Contador atendidos
    ctx.font = '13px Manrope, system-ui, sans-serif';
    ctx.fillStyle = colors.textBright;
    ctx.textAlign = 'right';
    ctx.fillText(`Atendidos: ${served}`, canvas.width - 20, canvas.height - 20);
    
    // Cantidad en cola
    const inQueue = balls.filter(b => b.state === 'queue').length;
    ctx.textAlign = 'left';
    ctx.fillText(`En cola: ${inQueue}`, 20, canvas.height - 20);
  }
  
  function drawBall(b) {
    ctx.beginPath();
    ctx.arc(b.x, b.y, L.ballR, 0, Math.PI * 2);
    
    let color = colors.ball;
    if (b.state === 'serving') color = colors.serving;
    if (b.state === 'exiting') color = colors.exit;
    
    ctx.fillStyle = color;
    ctx.fill();
    
    // Borde
    ctx.strokeStyle = 'rgba(255,255,255,0.4)';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    // Progreso de servicio
    if (b.state === 'serving' && b.serviceProgress > 0) {
      ctx.beginPath();
      ctx.arc(b.x, b.y, L.ballR + 5, -Math.PI/2, -Math.PI/2 + b.serviceProgress * Math.PI * 2);
      ctx.strokeStyle = colors.server;
      ctx.lineWidth = 3;
      ctx.stroke();
    }
  }
  
  function updateBalls(dt) {
    const speed = 200; // pixels per second
    
    balls.forEach(b => {
      if (b.state === 'arriving') {
        b.x = lerp(b.x, b.targetX, dt * 4);
        b.y = lerp(b.y, b.targetY, dt * 4);
        if (Math.abs(b.x - b.targetX) < 2 && Math.abs(b.y - b.targetY) < 2) {
          b.x = b.targetX;
          b.y = b.targetY;
          b.state = 'queue';
        }
      }
      
      if (b.state === 'queue') {
        // Moverse a posici√≥n en cola
        b.targetY = L.queueTopY + b.queueIndex * L.queueSpacing;
        b.y = lerp(b.y, b.targetY, dt * 6);
      }
      
      if (b.state === 'toServer') {
        b.x = lerp(b.x, L.serverX, dt * 5);
        b.y = lerp(b.y, L.serverY, dt * 5);
        if (Math.abs(b.x - L.serverX) < 3 && Math.abs(b.y - L.serverY) < 3) {
          b.x = L.serverX;
          b.y = L.serverY;
          b.state = 'serving';
          b.serviceProgress = 0;
          b.serviceDuration = randExp(mu);
          serverBusy = true;
        }
      }
      
      if (b.state === 'serving') {
        b.serviceProgress += dt / b.serviceDuration;
        if (b.serviceProgress >= 1) {
          b.state = 'exiting';
          b.serviceProgress = 1;
          serverBusy = false;
          served++;
        }
      }
      
      if (b.state === 'exiting') {
        b.x = lerp(b.x, L.exitX + 100, dt * 4);
      }
    });
    
    // Remover bolitas que salieron
    balls = balls.filter(b => b.state !== 'exiting' || b.x < canvas.width + 50);
    
    // Recalcular √≠ndices de cola
    let idx = 0;
    balls.filter(b => b.state === 'queue').forEach(b => {
      b.queueIndex = idx++;
    });
    
    // Mover primera bolita de la cola al servidor si est√° libre
    // Verificar que no haya nadie yendo al servidor o siendo atendido
    const someoneGoingOrServing = balls.some(b => b.state === 'toServer' || b.state === 'serving');
    if (!someoneGoingOrServing) {
      const firstInQueue = balls.find(b => b.state === 'queue' && b.queueIndex === 0);
      if (firstInQueue) {
        firstInQueue.state = 'toServer';
      }
    }
  }
  
  function spawnBall() {
    const queueCount = balls.filter(b => b.state === 'queue' || b.state === 'arriving').length;
    balls.push({
      state: 'arriving',
      x: L.arriveFromX,
      y: L.arriveY,
      targetX: L.queueX,
      targetY: L.queueTopY + queueCount * L.queueSpacing,
      queueIndex: queueCount,
      serviceProgress: 0,
      serviceDuration: 0
    });
  }
  
  let lastTime = 0;
  function loop(timestamp) {
    if (!running) return;
    
    const dt = lastTime ? (timestamp - lastTime) / 1000 : 0.016;
    lastTime = timestamp;
    
    simTime += dt;
    
    // Llegadas
    if (simTime >= nextArrival) {
      spawnBall();
      nextArrival = simTime + randExp(lambda);
    }
    
    updateBalls(dt);
    drawScene();
    balls.forEach(drawBall);
    
    requestAnimationFrame(loop);
  }
  
  function reset() {
    balls = [];
    served = 0;
    simTime = 0;
    nextArrival = randExp(lambda);
    serverBusy = false;
    lastTime = 0;
    drawScene();
  }
  
  function updateParamsText() {
    const rho = (lambda / mu).toFixed(2);
    document.getElementById('anim-params-text').textContent = 
      `Œª = ${lambda.toFixed(2)}, Œº = ${mu.toFixed(2)}, œÅ = ${rho}`;
  }
  
  // Event listeners
  document.getElementById('anim-lambda').addEventListener('input', function(e) {
    lambda = parseFloat(e.target.value);
    document.getElementById('anim-lambda-val').textContent = lambda.toFixed(2);
    updateParamsText();
  });
  
  document.getElementById('anim-mu').addEventListener('input', function(e) {
    mu = parseFloat(e.target.value);
    document.getElementById('anim-mu-val').textContent = mu.toFixed(2);
    updateParamsText();
  });
  
  document.getElementById('anim-start').addEventListener('click', function() {
    running = !running;
    this.textContent = running ? '‚è∏ Pausar' : '‚ñ∂ Iniciar';
    this.classList.toggle('active', running);
    if (running) {
      lastTime = 0;
      requestAnimationFrame(loop);
    }
  });
  
  document.getElementById('anim-reset').addEventListener('click', function() {
    running = false;
    document.getElementById('anim-start').textContent = '‚ñ∂ Iniciar';
    document.getElementById('anim-start').classList.remove('active');
    reset();
  });
  
  // Init
  reset();
  updateParamsText();
})();
</script>

<script is:inline>
  // Simulador M/M/1
  document.addEventListener("DOMContentLoaded", function() {
    var lambdaInput = document.getElementById("lambda");
    var muInput = document.getElementById("mu");
    var timeInput = document.getElementById("time");
    
    function updateLabels() {
      document.getElementById("lambda-value").textContent = parseFloat(lambdaInput.value).toFixed(2);
      document.getElementById("mu-value").textContent = parseFloat(muInput.value).toFixed(2);
      document.getElementById("time-value").textContent = timeInput.value;
    }
    
    lambdaInput.addEventListener("input", updateLabels);
    muInput.addEventListener("input", updateLabels);
    timeInput.addEventListener("input", updateLabels);
    
    function randExp(rate) { return -Math.log(1 - Math.random()) / rate; }
    
    function simulate(lambda, mu, simTime) {
      let t = 0, nextArrival = randExp(lambda);
      let serviceEndTimes = [], queue = [], waitTimes = [];
      let timeline = [[0, 0]], clientsInSystem = [[0, 0]];
      
      while (true) {
        const nextService = serviceEndTimes.length > 0 ? serviceEndTimes[0] : Infinity;
        
        if (nextArrival <= nextService && nextArrival <= simTime) {
          t = nextArrival;
          if (serviceEndTimes.length < 1) {
            serviceEndTimes.push(t + randExp(mu));
            serviceEndTimes.sort((a, b) => a - b);
            waitTimes.push(0);
          } else { queue.push(t); }
          nextArrival += randExp(lambda);
          timeline.push([t, queue.length]);
          clientsInSystem.push([t, queue.length + serviceEndTimes.length]);
        } else if (nextService < nextArrival && nextService <= simTime) {
          t = nextService;
          serviceEndTimes.shift();
          if (queue.length > 0) {
            waitTimes.push(t - queue.shift());
            serviceEndTimes.push(t + randExp(mu));
            serviceEndTimes.sort((a, b) => a - b);
          }
          timeline.push([t, queue.length]);
          clientsInSystem.push([t, queue.length + serviceEndTimes.length]);
        } else { break; }
        if (t > simTime) break;
      }
      
      if (timeline[timeline.length - 1][0] < simTime) {
        timeline.push([simTime, timeline[timeline.length - 1][1]]);
        clientsInSystem.push([simTime, clientsInSystem[clientsInSystem.length - 1][1]]);
      }
      
      let area = 0;
      for (let i = 0; i < timeline.length - 1; i++) area += timeline[i][1] * (timeline[i + 1][0] - timeline[i][0]);
      
      const rho = lambda / mu, stable = rho < 1;
      let L_theory = NaN, Lq_theory = NaN, W_theory = NaN, Wq_theory = NaN;
      if (stable && lambda > 0 && mu > 0) {
        L_theory = rho / (1 - rho);
        Lq_theory = (rho * rho) / (1 - rho);
        W_theory = 1 / (mu - lambda);
        Wq_theory = lambda / (mu * (mu - lambda));
      }
      
      return { timeline, clientsInSystem, waitTimes, Lq_sim: area / simTime, Wq_sim: waitTimes.length > 0 ? waitTimes.reduce((a, b) => a + b, 0) / waitTimes.length : 0, rho, stable, L_theory, Lq_theory, W_theory, Wq_theory };
    }
    
    var darkLayout = {
      paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0.15)',
      font: { color: '#94a3b8', family: 'Manrope, sans-serif', size: 11 },
      margin: { t: 30, b: 40, l: 50, r: 20 },
      xaxis: { gridcolor: 'rgba(255,255,255,0.05)', zerolinecolor: 'rgba(255,255,255,0.1)' },
      yaxis: { gridcolor: 'rgba(255,255,255,0.05)', zerolinecolor: 'rgba(255,255,255,0.1)' }
    };
    
    function runSimulation() {
      var lambda = parseFloat(lambdaInput.value), mu = parseFloat(muInput.value), simTime = parseInt(timeInput.value);
      var res = simulate(lambda, mu, simTime);
      
      document.getElementById("rho-out").textContent = res.rho.toFixed(4);
      document.getElementById("stable-out").textContent = res.stable ? "‚úì Estable" : "‚ö†Ô∏è Inestable";
      document.getElementById("stable-out").className = res.stable ? "stable" : "unstable";
      
      if (res.stable) {
        document.getElementById("l-out").textContent = res.L_theory.toFixed(4);
        document.getElementById("lq-out").textContent = res.Lq_theory.toFixed(4);
        document.getElementById("w-out").textContent = res.W_theory.toFixed(4);
        document.getElementById("wq-out").textContent = res.Wq_theory.toFixed(4);
      } else {
        ["l-out", "lq-out", "w-out", "wq-out"].forEach(id => document.getElementById(id).textContent = "‚àû");
      }
      
      Plotly.newPlot("queue-chart", [{ x: res.timeline.map(p => p[0]), y: res.timeline.map(p => p[1]), type: "scatter", mode: "lines", fill: "tozeroy", line: { color: "#10b981", width: 2 }, fillcolor: "rgba(16,185,129,0.2)" }], Object.assign({}, darkLayout, { title: `Cola M/M/1 (Œª=${lambda}, Œº=${mu})`, xaxis: { ...darkLayout.xaxis, title: "Tiempo (s)" }, yaxis: { ...darkLayout.yaxis, title: "Clientes en cola" }, height: 350 }), { responsive: true });
      
      if (res.waitTimes.length > 0) Plotly.newPlot("wait-hist", [{ x: res.waitTimes, type: "histogram", nbinsx: 30, marker: { color: "#3b82f6" } }], Object.assign({}, darkLayout, { xaxis: { ...darkLayout.xaxis, title: "Tiempo de espera (s)" }, yaxis: { ...darkLayout.yaxis, title: "Frecuencia" }, height: 280 }), { responsive: true });
      
      Plotly.newPlot("clients-chart", [{ x: res.clientsInSystem.map(p => p[0]), y: res.clientsInSystem.map(p => p[1]), type: "scatter", mode: "lines", line: { color: "#8b5cf6", width: 2 }, fill: "tozeroy", fillcolor: "rgba(139,92,246,0.15)" }], Object.assign({}, darkLayout, { xaxis: { ...darkLayout.xaxis, title: "Tiempo (s)" }, yaxis: { ...darkLayout.yaxis, title: "Clientes" }, height: 280 }), { responsive: true });
    }
    
    document.getElementById("run-sim").addEventListener("click", runSimulation);
    runSimulation();
    
    // KaTeX
    function tryKaTeX() {
      if (typeof katex === "undefined") { setTimeout(tryKaTeX, 100); return; }
      var formulas = { "f-rho": "\\rho = \\frac{\\lambda}{\\mu}", "f-l": "L = \\frac{\\rho}{1 - \\rho}", "f-lq": "L_q = \\frac{\\rho^2}{1 - \\rho}", "f-w": "W = \\frac{1}{\\mu - \\lambda}" };
      Object.keys(formulas).forEach(id => { var el = document.getElementById(id); if (el) katex.render(formulas[id], el, { displayMode: false, throwOnError: false }); });
    }
    tryKaTeX();
    
    // Distribuciones
    var interarrivals = [], serviceTimes = [];
    for (var i = 0; i < 100; i++) { interarrivals.push(-Math.log(Math.random()) / 0.3057); serviceTimes.push(-Math.log(Math.random()) / 0.8185); }
    Plotly.newPlot("dist-charts", [{ x: interarrivals, type: "histogram", nbinsx: 20, name: "Interarrivals", marker: { color: "#3b82f6", opacity: 0.7 } }, { x: serviceTimes, type: "histogram", nbinsx: 20, name: "Servicio", marker: { color: "#10b981", opacity: 0.7 } }], Object.assign({}, darkLayout, { barmode: "overlay", xaxis: { ...darkLayout.xaxis, title: "Tiempo (s)" }, yaxis: { ...darkLayout.yaxis, title: "Frecuencia" }, height: 280, showlegend: true, legend: { x: 0.7, y: 0.95 } }), { responsive: true });
  });
</script>

<style>
  /* Animaci√≥n M/M/1 */
  .anim-section {
    margin-top: 40px;
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 28px;
    background: linear-gradient(135deg, rgba(88,166,255,0.03), rgba(163,113,247,0.02));
  }
  
  .anim-wrapper {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  
  .anim-params {
    text-align: center;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 15px;
    color: var(--muted);
    padding: 10px;
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
    border: 1px solid var(--border);
  }
  
  #mm1-canvas {
    display: block;
    width: 100%;
    max-width: 700px;
    height: auto;
    margin: 0 auto;
    border-radius: 16px;
    border: 1px solid var(--border);
  }
  
  .anim-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
  }
  
  .slider-group {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
  }
  
  .slider-group label {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    padding: 10px 16px;
    border-radius: 10px;
    font-size: 13px;
    color: var(--muted);
  }
  
  .slider-group input[type="range"] {
    width: 100px;
    accent-color: #58a6ff;
  }
  
  .slider-val {
    font-weight: 700;
    color: #58a6ff;
    font-family: 'JetBrains Mono', monospace;
    min-width: 40px;
    text-align: right;
  }
  
  .anim-btns {
    display: flex;
    gap: 10px;
  }
  
  .btn-start {
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    background: #238636;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
  }
  
  .btn-start:hover {
    background: #2ea043;
    box-shadow: 0 4px 15px rgba(35,134,54,0.3);
  }
  
  .btn-start.active {
    background: #f0883e;
  }
  
  .btn-reset {
    padding: 10px 16px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
  }
  
  .btn-reset:hover {
    border-color: #58a6ff;
    color: #58a6ff;
  }
  
  @media (max-width: 700px) {
    .anim-controls {
      flex-direction: column;
      align-items: stretch;
    }
    .slider-group {
      flex-direction: column;
    }
    .anim-btns {
      justify-content: center;
    }
  }

  /* Simulador */
  .sim { margin-top: 40px; border: 1px solid var(--border); border-radius: 24px; padding: 28px; background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); }
  .sim-grid { display: grid; gap: 20px; }
  .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 14px; }
  label { display: grid; gap: 6px; font-size: 14px; color: var(--muted); background: rgba(255,255,255,0.02); border: 1px solid var(--border); padding: 14px; border-radius: 12px; }
  input[type="range"] { width: 100%; accent-color: var(--accent); }
  .value { font-weight: 700; color: var(--accent); text-align: center; }
  .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; }
  .metric { padding: 16px; border: 1px solid var(--border); border-radius: 14px; background: rgba(255,255,255,0.02); text-align: center; }
  .metric h3 { margin: 6px 0 2px; font-size: 24px; color: var(--accent); }
  .metric p { font-size: 12px; color: var(--muted); }
  .metric small { font-size: 11px; }
  .metric small.stable { color: var(--accent); }
  .metric small.unstable { color: var(--danger); }
  .actions { display: flex; gap: 12px; }
  .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
  .chart-half { background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 14px; padding: 16px; }
  .chart-half h4 { margin: 0 0 10px; font-size: 14px; color: var(--muted); }
  .formula-section { padding: 20px; background: linear-gradient(135deg, rgba(16,185,129,0.05), rgba(59,130,246,0.03)); border: 1px solid var(--border); border-radius: 14px; margin-top: 20px; }
  .formula-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 14px; margin-top: 14px; }
  .formula-item { padding: 12px 16px; background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 10px; }
  .formula-label { font-size: 11px; color: var(--accent); text-transform: uppercase; display: block; margin-bottom: 6px; }
  .formula-math { font-size: 16px; color: var(--ink); }

  /* Resultados */
  .results { margin-top: 40px; }
  .results-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
  .result-card { padding: 20px; border: 1px solid var(--border); border-radius: 18px; background: rgba(255,255,255,0.02); }
  .result-card.wide { grid-column: span 2; }
  .result-card.highlight { border-color: var(--accent); background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(59,130,246,0.04)); }
  .result-card.comparison { border-color: var(--accent-2); }
  .result-card h4 { margin: 0 0 16px; font-size: 16px; }
  .param-row { display: flex; gap: 12px; flex-wrap: wrap; }
  .param { flex: 1; min-width: 140px; text-align: center; padding: 14px; background: rgba(0,0,0,0.2); border-radius: 12px; border: 1px solid var(--border); }
  .param.accent { border-color: var(--accent); background: rgba(16,185,129,0.1); }
  .param-label { display: block; font-size: 11px; color: var(--muted); margin-bottom: 4px; }
  .param-value { display: block; font-size: 24px; font-weight: 700; color: var(--ink); font-family: "Space Grotesk", sans-serif; }
  .param.accent .param-value { color: var(--accent); }
  .param-unit { display: block; font-size: 11px; color: var(--muted); margin-top: 2px; }
  .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .data-table td, .data-table th { padding: 10px 8px; border-bottom: 1px solid var(--border); text-align: left; }
  .data-table td.val { text-align: right; font-weight: 600; color: var(--ink); }
  .data-table td.warn { color: var(--warning); }
  .data-table th { color: var(--muted); font-weight: 600; font-size: 11px; text-transform: uppercase; }
  .note { font-size: 12px; color: var(--muted); margin-top: 12px; font-style: italic; }

  @media (max-width: 900px) {
    .charts-row { grid-template-columns: 1fr; }
    .results-grid { grid-template-columns: 1fr; }
    .result-card.wide { grid-column: span 1; }
  }
</style>
